<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P-CARS - Trouvez Votre Voiture d'Occasion Id√©ale</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    body {
      background: linear-gradient(to bottom, rgba(9, 31, 82, 0.192), rgba(1, 9, 20, 0.171)),
      url('arier.png') no-repeat center center fixed;
      background-size: cover;
      color: #e2e8f0;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    header {
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 14px 10px 20px 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      gap: 40px;
    }
    header img {
      max-height: 110px;
      width: auto;
      object-fit: contain;
      transition: transform 0.3s;
    }
    header img:hover { transform: scale(1.05);}
    header .header-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    header h1 {
      font-size: 2.4rem;
      font-weight: 700;
      color: #e98a1e;
      margin-bottom: 0.3em;
    }
    header .text-h {
      font-size: 1.1rem;
      color: #effafa;
      letter-spacing: 0.5px;
    }
    @media (max-width: 750px) {
      header { flex-direction: column; gap: 12px;}
      header img { max-width: 70%;}
    }
    .navbar {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      margin-top: 1rem;
      justify-content: center;
    }
    .lang-btns {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .lang-btns button {
      width: 34px; height: 34px;
      border-radius: 50%;
      border: 2px solid #3b82f6;
      background: #1e293b;
      color: #3b82f6;
      font-weight: bold;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.3s;
      font-size: 1rem;
    }
    .lang-btns button.active, .lang-btns button:hover { background: #3b82f6; color: #fff;}
    .home-btn {
      margin-left: 0.7rem;
      background: #fff;
      color: #1e293b;
      border-radius: 20px;
      padding: 8px 16px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      text-decoration: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.07);
      transition: background 0.2s, color 0.2s;
    }
    .home-btn:hover { background: #3b82f6; color: #fff;}
    footer {
      text-align:center;
      margin: 20px 0 0 0;
      color: #e2e8f0;
      background: rgba(255,255,255,0.06);
      border-radius: 15px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
      padding: 16px;
      font-size: 0.97rem;
    }
    .header-nav {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 30px;
    }
    .header-nav a {
      color: #3bf6e6;
      font-weight: 500;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 8px;
      transition: background 0.3s ease;
    }
    .header-nav a:hover {
      background: rgba(115, 59, 246, 0.562);
    }
    .welcome-section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      padding: 40px 30px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
      margin-bottom: 30px;
      transition: transform 0.3s ease;
    }
    .welcome-section:hover {
      transform: translateY(-5px);
    }
    .welcome-section h2 {
      font-size: 2.5rem;
      font-weight: 700;
      color: #3b82f6;
      margin-bottom: 15px;
    }
    .welcome-section p {
      font-size: 1.2rem;
      color: #eaecf0;
      margin-bottom: 25px;
    }
    .welcome-section button {
      background: #3b82f6;
      color: #ffffff;
      font-size: 1.1rem;
      font-weight: 600;
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    .welcome-section button:hover {
      background: #2563eb;
      transform: scale(1.05);
    }
.filters {
  background: rgba(19, 18, 18, 0.644);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 12px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
  color: #e2e8f0;
  align-items: start;
}
    .filters label {
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: block;
    }
    .filters input,
    .filters select {
      padding: 10px;
      background: #1e293b;
      color: #e2e8f0;
      border: 1px solid #3b82f6;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .filters input:focus,
    .filters select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    .car-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }
    .car {
      background: #1e293b;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }
    .car:hover {
      transform: scale(1.02);
    }
    .car img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .car-details {
      padding: 20px;
    }
    .car h3 {
      font-size: 1.4rem;
      color: #ffffff;
      margin-bottom: 10px;
    }
    .car p {
      font-size: 0.95rem;
      color: #cbd5e1;
      margin-bottom: 6px;
    }
    .car button {
      background: #3b82f6;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .car button:hover {
      background: #2563eb;
    }
    /* Modal styles */
    .modal-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s;
    }
    .modal {
      background: #1e293b;
      border-radius: 18px;
      max-width: 800px;
      width: 97vw;
      max-height: 95vh;
      overflow-y: auto;
      padding: 30px 24px 20px 24px;
      position: relative;
      color: #fff;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45);
    }
    .modal-close {
      position: absolute;
      top: 12px;
      right: 18px;
      background: none;
      border: none;
      color: #f87171;
      font-size: 2rem;
      cursor: pointer;
    }
    .modal-images {
      display: flex;
      gap: 9px;
      overflow-x: auto;
      margin-bottom: 18px;
    }
    .modal-images img {
      height: 160px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.16);
      object-fit: cover;
      background: #222;
    }
    .modal-details {
      margin-bottom: 18px;
    }
    .modal-details p {
      margin: 6px 0;
      font-size: 1.08rem;
    }
    .modal-actions {
      display: flex;
      gap: 18px;
      justify-content: center;
      margin-top: 15px;
    }
    .modal-actions button {
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    .modal-actions button:hover {
      background: #2563eb;
    }
    @media (max-width: 768px) {
      header { flex-direction: column; text-align: center;}
      header img { max-width: 68%;}
      .header-nav { flex-direction: column; gap: 10px;}
      .filters { grid-template-columns: 1fr; }
      .car img { height: 160px; }
      .modal { padding: 15px 7px 10px 7px; }
      .modal-actions button { padding: 10px 8px; font-size: 1rem;}
    }
    #modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal {
      background: rgba(42, 7, 82, 0.466);
      padding: 20px;
      max-width: 800px;
      width: 90%;
      border-radius: 10px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 22px;
      background: transparent;
      border: none;
      cursor: pointer;
    }
    .modal-images img {
      max-width: 100%;
      margin: 5px 0;
    }
    .swiper {
      width: 100%;
      height: 400px;
    }
    .swiper-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Actions */
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
       main {
        flex: 1;
        padding: 40px;
        color: white;
    }

    /* Conteneur pagination */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 40px 0;
    }

    .btn-circle {
        position: relative;
        width: 55px;
        height: 55px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        color: white;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        transition: transform 0.25s ease, opacity 0.25s ease, box-shadow 0.3s ease;
        overflow: hidden;
    }

    .btn-circle:hover {
        transform: translateY(-4px) scale(1.08);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.8), 0 0 30px rgba(0, 255, 255, 0.5);
    }

    .btn-circle:active::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(0, 255, 255, 0.4);
        border-radius: 50%;
        animation: ripple 0.5s ease;
    }

    @keyframes ripple {
        from { transform: scale(0); opacity: 0.8; }
        to { transform: scale(2); opacity: 0; }
    }

    svg {
        width: 24px;
        height: 24px;
    }

    .hidden {
        opacity: 0;
        transform: scale(0.5);
        pointer-events: none;
    }

    footer {
        background: rgba(255,255,255,0.05);
        text-align: center;
        padding: 20px;
        color: white;
    }
#forum {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-sizing: border-box;
}

.modal-content {
    background: #fcfafa88;
    width: 80%;
    height: 90%;
    border-radius: 12px;
    padding: 20px;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    position: relative;
    display: flex;
    flex-direction: column;
}

.close {
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 28px;
    cursor: pointer;
}

#forum-body {
    flex: 1;
    white-space: pre-wrap;
    font-family: monospace;
    overflow: auto;
  }
  </style>
</head>
<body>
<header>
  <img src="logo1.png" alt="Logo soci√©t√© m√®re">
  <div class="header-center">
    <h1>P2P-CARS</h1>
    <p class="text-h">Plateforme de Voitures d'Occasion</p>
  </div>
  <img src="logo4.png" alt="Logo plateforme">
</header>
<div class="navbar">
  <div class="lang-btns">
    <button id="lang-fr" aria-label="Fran√ßais">FR</button>
    <button id="lang-en" aria-label="English">EN</button>
    <button id="lang-ar" aria-label="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">AR</button>
  </div>
  <a href="https://p2p-cars.com" class="home-btn"><i class="fas fa-home"></i> Accueil</a>
</div>
<nav class="header-nav">
  <a href="https://p2p-cars.com" id="nav-accueil">Accueil</a>
  <a href="https://p2p-cars.com/esprix" id="nav-simulateur">Simulateur Prix</a>
  <a href="https://p2p-cars.com/carservices" id="nav-services">Services P2P-Cars</a>
  <a href="https://p2p-cars.com/login" id="nav-login">Espace personnel </a>
</nav>
<section class="welcome-section" id="welcome-section">
  <h2 id="welcome-title">Bienvenue sur P2P-CARS</h2>
  <p id="welcome-desc">D√©couvrez ici les meilleures offres de voitures d'occasion, annoncez la vente de la v√¥tre en toute simplicit√©, ou demandez √† trouver et √† acheter pr√©cis√©ment la voiture d'occasion qui correspond √† vos besoins...</p>
  <button id="btn">Envoyer une demande</button>
</section>
<section class="filters">
  <label for="search" id="filter-search-label">Rechercher:</label>
  <input type="text" id="search" placeholder="Rechercher...">
  <label for="marque" id="filter-marque-label">Marque:</label>
  <select id="marque"></select>
  <label for="modele" id="filter-modele-label">Mod√®le:</label>
  <select id="modele"></select>
  <label for="annee" id="filter-annee-label">Ann√©e:</label>
  <select id="annee"></select>
  <label for="kilometrage" id="filter-kilometrage-label">Kilom√©trage max:</label>
  <input type="number" id="kilometrage" placeholder="Kilom√©trage max">
  <label for="carburant" id="filter-carburant-label">Carburant:</label>
  <select id="carburant"></select>
  <label for="puissance" id="filter-puissance-label">Puissance max (CV):</label>
  <input type="number" id="puissance" placeholder="Puissance max (CV)">
  <label for="ville" id="filter-ville-label">Ville:</label>
  <select id="ville"></select>
  <button id="reset-filters" style="grid-column: span 2; background:#e98a1e; color:#fff; border:none; border-radius:8px; padding:10px 20px; font-weight:600; cursor:pointer;">R√©initialiser</button>
</section>
<section class="car-list" id="carList">
  <!-- Car listings will be dynamically added here -->
</section>
<div class="pagination">
    <button id="prev" class="btn-circle">
        <svg viewBox="0 0 24 24" fill="none" stroke="cyan" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </button>

    <button id="page" class="btn-circle">
        <span>0</span>
    </button>

    <button id="next" class="btn-circle">
        <svg viewBox="0 0 24 24" fill="none" stroke="cyan" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </button>
</div>
<footer>
  &copy; 2025 IASMarket Services. Tous droits r√©serv√©s.
</footer>
<div id="modal-bg" style="display:none"></div>
<div id="contact-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(148, 136, 136, 0.5); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:rgba(8, 8, 8, 0.863); padding:20px; border-radius:10px; width:300px; position:relative; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
    <span id="close-modal" style="position:absolute; top:5px; right:10px; cursor:pointer; font-size:18px;">&times;</span>
    <h3 id="msg-title" style="text-align:center; color:#fff; margin-bottom:20px;"></h3>
    <p id="msg-label"></p>
    <label for="montant-propose">Montant propos√© :</label>
    <input type="text" id="montant-propose" placeholder="Entrez votre montant">
    <p id="error-montant" style="color:rgb(245, 45, 45);"></p>
    <label>Message:</label>
    <textarea id="contact-message" style="width:100%; margin-bottom:10px;" placeholder="Votre message"></textarea>
    <button id="send-btn">Envoyer ‚úâÔ∏è</button>
  </div>
</div>
<div id="forum" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0, 0, 0, 0.616); justify-content:center; align-items:center;">
    <div style="background:rgba(8, 8, 8, 0.842); padding:20px; border-radius:10px; width:90%; max-width:1000px; position:relative; max-height:90vh; overflow:auto;">
        <span class="close" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px;">&times;</span>
        <h2 id="forum-title" style="text-align:center; color:#fff; margin-bottom:20px;">Nouveau Titre du Forum</h2>
        <div id="forum-body" style="color:#fff; overflow-y:auto; max-height:60vh; padding-right:10px;">
            Chargement...
        </div>
        <div id="forume-body" style="color:#fff; overflow-y:auto; max-height:60vh; padding-right:10px;">
            Chargement...
        </div>
    </div>
</div>
<div id="confirmationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(248, 246, 246, 0.61); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:rgba(0, 0, 0, 0.705); padding:20px 30px; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.3); max-width:400px; width:80%; text-align:center; position:relative;">
        <span id="closeModal" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; font-weight:bold;">&times;</span>
        <p id="modalMessage" style="margin-bottom:20px; font-size:16px;"></p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button id="confirmBtn" style="padding:8px 16px; border:none; border-radius:5px; background:#4CAF50; color:white; cursor:pointer; font-size:14px;">Confirmer</button>
            <button id="cancelBtn" style="padding:8px 16px; border:none; border-radius:5px; background:#f44336; color:white; cursor:pointer; font-size:14px;">Annuler</button>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
const userEmail = localStorage.getItem('userEmail');
document.addEventListener("DOMContentLoaded", async function () {
    await initMaxPage();
    document.querySelector("#page span").textContent = 0;
    document.getElementById("prev").classList.add("hidden");
});
const apiURL = "https://apicars.p2p-cars.com/api/getannonce";
const imgBase = "https://apicars.p2p-cars.com/";
const translations = { /* ... √† remplir ... */ };
document.getElementById("lang-fr").addEventListener("click", ()=>setLang("fr"));
document.getElementById("lang-en").addEventListener("click", ()=>setLang("en"));
document.getElementById("lang-ar").addEventListener("click", ()=>setLang("ar"));
let currentLang = "fr";
function setLang(lang) {
  currentLang = lang;
  displayCars(0);
  document.documentElement.lang = lang;
  document.body.style.direction = (lang === 'ar' ? 'rtl' : 'ltr');
  [
    'welcome-title','welcome-desc','btn','filter-search-label','filter-marque-label',
    'filter-modele-label','filter-annee-label','filter-kilometrage-label','filter-carburant-label','filter-puissance-label',
    'nav-accueil','nav-simulateur','nav-services','nav-login'
  ].forEach(id => {
    let el = document.getElementById(id);
    if (el && translations[lang][id]) el.textContent = translations[lang][id];
  });
  document.querySelector('.home-btn').innerHTML = `<i class="fas fa-home"></i> ${translations[lang]['home']}`;
  ['fr','en','ar'].forEach(l=>{
    document.getElementById('lang-'+l).classList.remove('active');
  });
  document.getElementById('lang-'+lang).classList.add('active');
  document.getElementById('search').placeholder = translations[lang]['filter-search-ph'];
  document.getElementById('kilometrage').placeholder = translations[lang]['filter-kilometrage-ph'];
  document.getElementById('puissance').placeholder = translations[lang]['filter-puissance-ph'];
  let marqueSel = document.getElementById('marque');
  marqueSel.innerHTML = `<option value="">${translations[lang]['filter-marque-ph']}</option>` +
    translations[lang]['brands'].map(m=>`<option value="${m}">${m}</option>`).join('');
  fillModelSelect();
  let anneeSel = document.getElementById('annee');
  anneeSel.innerHTML = `<option value="">${translations[lang]['filter-annee-ph']}</option>`;
  for (let y = new Date().getFullYear(); y >= 2000; y--) {
    anneeSel.innerHTML += `<option value="${y}">${y}</option>`;
  }
  let carburantSel = document.getElementById('carburant');
  carburantSel.innerHTML = `<option value="">${translations[lang]['filter-carburant-ph']}</option>` +
    translations[lang]['fuels'].map(f=>`<option value="${f}">${f}</option>`).join('');
  let villeSel = document.getElementById('ville');
  villeSel.innerHTML = `<option value="">${translations[lang]['filter-ville-ph']}</option>` +
    translations[lang]['ville'].map(m=>`<option value="${m}">${m}</option>`).join('');
}
async function countExistingCarFiles() {
  let page = 0;
  let exists = true;
  let count = 0;
  while (exists) {
    try {
      const response = await fetch(`https://p2p-cars.com/generatedjs/cars-${page}.js`);
      if (response.ok) {
        count++;
        page++;
      } else {
        exists = false;
      }
    } catch (error) {
      exists = false;
    }
  }
  return count;
}
let maxPage = null;
async function initMaxPage() {
    if (maxPage === null) {
        maxPage = await countExistingCarFiles();
    }
    return maxPage;
}
function displayCars(page) {
  fillModelSelect();
  fallbackDisplayCars(page);
}
document.getElementById('next').addEventListener('click', nextPage);
document.getElementById('prev').addEventListener('click', prevPage);
async function nextPage() {
    let currentPag = parseInt(document.querySelector("#page span").textContent, 10);
    const max = await initMaxPage();
    if(currentPag === max - 1) return;
    currentPag++;
    document.getElementById("next").classList.toggle("hidden", currentPag === max - 1);
    document.getElementById("prev").classList.toggle("hidden", currentPag === 0);
    displayCars(currentPag);
    document.querySelector("#page span").textContent = currentPag;   
}
async function prevPage() {
    let currentPag = parseInt(document.querySelector("#page span").textContent, 10);
    const max = await initMaxPage();
    if(currentPag === 0) return;
    currentPag--;
    document.getElementById("prev").classList.toggle("hidden", currentPag === 0);
    document.getElementById("next").classList.toggle("hidden", currentPag === max - 1);
    displayCars(currentPag);
    document.querySelector("#page span").textContent = currentPag;   
}
function loadCarsFromJS(page, callback) {
    const script = document.createElement("script");
    script.src = `https://p2p-cars.com/generatedjs/cars-${page}.js?nocache=${Date.now()}`;
    script.onload = function () {
        const carsVar = window['cars' + page];
        if (typeof carsVar !== "undefined") {
            callback(carsVar);
        } else {
            callback([]);
        }
    };
    script.onerror = function () {
        callback([]);
    };
    document.body.appendChild(script);
}
function fallbackDisplayCars(page) {
  loadCarsFromJS(page, function(cars) {
    document.body.setAttribute("data-page", page);
    const list = document.getElementById("carList");
    const search = document.getElementById("search").value.toLowerCase();
    const marque = document.getElementById("marque").value;
    const modele = document.getElementById("modele").value;
    const annee = document.getElementById("annee").value;
    const kilometrage = document.getElementById("kilometrage").value;
    const carburant = document.getElementById("carburant").value;
    const puissance = document.getElementById("puissance").value;
    const ville = document.getElementById("ville").value;
    const filtered = cars.filter(c => {
      return (
        (search === "" ||
          c.marque.toLowerCase().includes(search) ||
          c.modele.toLowerCase().includes(search) ||
          (c.description && c.description.toLowerCase().includes(search)) ||
          (c.ville && c.ville.toLowerCase().includes(search)) ||
          (c.annee && c.annee.toString().includes(search)) ||
          (c.carburant && c.carburant.toLowerCase().includes(search)) ||
          (c.kilometrage && c.kilometrage.toString().includes(search)) ||
          (c.puissance && c.puissance.toString().includes(search))
        ) &&
        (marque === "" || c.marque.toLowerCase() === marque.toLowerCase()) &&
        (modele === "" || c.modele.toLowerCase() === modele.toLowerCase()) &&
        (annee === "" || parseInt(c.annee) === parseInt(annee)) &&
        (kilometrage === "" || c.kilometrage <= parseInt(kilometrage || Infinity)) &&
        (carburant === "" || c.carburant.toLowerCase() === carburant.toLowerCase()) &&
        (puissance === "" || c.puissance <= parseInt(puissance || Infinity)) &&
        (ville === "" || c.ville.toLowerCase() === ville.toLowerCase())
      );
    });
    list.innerHTML = "";
    filtered.forEach(c => {
      const div = document.createElement("div");
      div.className = "car";
      let imagesArr = Array.isArray(c.images)
        ? c.images.map(img => "https://p2p-cars.com/" + img.replace(/\\/g, "/"))
        : ["datatof/default.jpg"];
      div.innerHTML = `
        <img src="${imagesArr[0]}" alt="${c.marque} ${c.modele}"
            onerror="
              const exts = ['jpeg','jpg','png','webp'];
              for(let i=0;i<exts.length;i++){
                if(this.src.includes(exts[i])) continue;
                const newSrc = this.src.replace(/\\.[a-z]+$/i,'.'+exts[i]);
                const imgTest = new Image();
                imgTest.onload=()=>{ this.src=newSrc; return true; };
                imgTest.onerror=()=>{};
                imgTest.src=newSrc;
              }
              this.onerror=null;
              this.src='datatof/default.jpg';
            ">
        <div class="car-details">
          <h3>${c.marque} ${c.modele} (${c.annee})</h3>
          <p><strong>${translations[currentLang]['filter-kilometrage-label']}</strong> ${c.kilometrage} km</p>
          <p><strong>${translations[currentLang]['filter-carburant-label']}</strong> ${c.carburant}</p>
          <p><strong>${translations[currentLang]['filter-puissance-label']}</strong> ${c.puissance}</p>
          <p>${c.description}</p>
          <p>${c.ville}</p>
          <button class="consult-btn" data-ref="${c.Ref}">${translations[currentLang]['consult-btn']}</button>
        </div>
      `;
      list.appendChild(div);
      div.querySelector(".consult-btn").addEventListener("click", () => openModal(c));
    });
  });
}
document.getElementById("marque").addEventListener("change", displayCars);
document.getElementById("modele").addEventListener("change", displayCars);
document.getElementById("annee").addEventListener("change", displayCars);
document.getElementById("kilometrage").addEventListener("input", displayCars);
document.getElementById("carburant").addEventListener("change", displayCars);
document.getElementById("puissance").addEventListener("input", displayCars);
document.getElementById("search").addEventListener("input", displayCars);
document.getElementById("ville").addEventListener("change", displayCars);
// RESET button logic
document.getElementById('reset-filters').addEventListener('click', function() {
    document.getElementById('search').value = "";
    document.getElementById('marque').value = "";
    fillModelSelect();
    document.getElementById('modele').value = "";
    document.getElementById('annee').value = "";
    document.getElementById('kilometrage').value = "";
    document.getElementById('carburant').value = "";
    document.getElementById('puissance').value = "";
    document.getElementById('ville').value = "";
    displayCars(0);
    document.querySelector("#page span").textContent = 0;
    document.getElementById("prev").classList.add("hidden");
});
function fillModelSelect() {
  let marque = document.getElementById('marque').value;
  let modeleSel = document.getElementById('modele');
  modeleSel.innerHTML = `<option value="">${translations[currentLang]['filter-modele-ph']}</option>`;
  if (translations[currentLang]['models'][marque]) {
    translations[currentLang]['models'][marque].forEach(m => {
      modeleSel.innerHTML += `<option value="${m}">${m}</option>`;
    });
  }
}
function transformResponseToArray(data) {
  const keys = Object.keys(data);
  if (keys.length === 0) return [];
  const length = data[keys[0]].length;
  const result = [];
  for (let i = 0; i < length; i++) {
    const obj = {};
    keys.forEach(key => {
      obj[key] = data[key][i];
    });
    result.push(obj);
  }
  return result;
}
function openModal(car) {
  let imagesArr = Array.isArray(car.images)
    ? car.images
    : (typeof car.images === "string" ? car.images.split(/[,;]/) : []);
  imagesArr = imagesArr.map(img =>
    "https://p2p-cars.com/" + img.replace(/\\/g, "/")
  );
  let priceStr = car.prix ? car.prix + " MAD" : "";
  let modalBg = document.getElementById("modal-bg");
  modalBg.innerHTML = `
    <div class="modal">
      <button class="modal-close" aria-label="${translations[currentLang]['modal-close']}">&times;</button>
      <h2>${translations[currentLang]['modal-title']}</h2>
      <div class="swiper">
        <div class="swiper-wrapper">
          ${imagesArr.map(img => `<div class="swiper-slide"><img src="${img}" alt=""></div>`).join("")}
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>
      <div class="modal-details">
        <p><strong>${translations[currentLang]['modal-date']}:</strong> ${car.date || ""}</p>
        <p><strong>${translations[currentLang]['modal-kilometrage']}:</strong> ${car.kilometrage || ""} km</p>
        <p><strong>${translations[currentLang]['modal-carburant']}:</strong> ${car.carburant || ""}</p>
        <p><strong>${translations[currentLang]['modal-puissance']}:</strong> ${car.cv || ""}</p>
        <p><strong>${translations[currentLang]['modal-price']}:</strong> ${priceStr}</p>
        <p>${car.description || ""}</p>
        <p>${car.ville || ""}</p>
      </div>
      <div class="modal-actions">
        <button id="contact-btn">${translations[currentLang]['modal-contact']}</button>
        <button id="buy-btn">${translations[currentLang]['modal-buy']}</button>
        <button id="forum-btn">${translations[currentLang]['modal-forume']}</button>
      </div>
    </div>
  `;
  modalBg.style.display = "flex";
  modalBg.querySelector(".modal-close").onclick = () => modalBg.style.display = "none";
  modalBg.onclick = (e) => {
    if (e.target === modalBg) modalBg.style.display = "none";
  };
  const modal = document.getElementById('contact-modal');
  const msgLabel = document.getElementById('msg-label');
  const closeModal = document.getElementById('close-modal');
  document.getElementById("contact-btn").onclick = function () {
    modal.style.display = 'flex';
  };
  const sendBtn = document.getElementById("send-btn");
  if (userEmail===null){
    msgLabel.innerHTML = translations[currentLang]['noconect'];
    msgLabel.style.color = "red";
    sendBtn.disabled = true;
    sendBtn.style.backgroundColor = "red";
    sendBtn.style.color = "white";
  }else{
    msgLabel.textContent = "Vous √™tes connect√© en tant que : " + userEmail;
    msgLabel.style.color = "green";
    sendBtn.disabled = false;
    sendBtn.style.backgroundColor = "green";
    sendBtn.style.color = "white";
  }
  closeModal.onclick = function() {
    modal.style.display = 'none';
  };
  window.onclick = function(event) {
    if(event.target == modal) modal.style.display = 'none';
  };
  document.getElementById('send-btn').onclick = async function() {
    const email = localStorage.getItem('userEmail');
    const message = document.getElementById('contact-message').value;
    const poffre=document.getElementById('montant-propose').value;
    const data = {
        Ref: car.Ref,
        email: email,
        poffre:poffre,
        message: message
    };
    try {
        const response = await fetch('https://apicars.p2p-cars.com/api/msgsellr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        if (response.ok) {
            alert("Message envoy√© !");
            modal.style.display = 'none';
        } else {
            const errorData = await response.json();
            alert("Erreur lors de l'envoi : " + (errorData.message || response.status));
        }
    } catch (error) {
        alert("Impossible d'envoyer le message. V√©rifiez votre connexion.");
    }
  };
  let selectedRef = car.Ref ;
  const modalc = document.getElementById("confirmationModal");
  const modalMessage = document.getElementById("modalMessage");
  const confirmBtn = document.getElementById("confirmBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const closeModalc = document.getElementById("closeModal");
  document.getElementById("buy-btn").onclick = function() {
    modalMessage.textContent = translations[currentLang]['commander']+userEmail+translations[currentLang]['engagement'];
    confirmBtn.textContent = translations[currentLang]['commanderB'];
    cancelBtn.textContent = translations[currentLang]['AnnulerB'];
    modalc.style.display = "flex";
  };
  confirmBtn.onclick = function() {
    if (userEmail === null){
      alert("‚ö†Ô∏è" + translations[currentLang]['noconect']);
      return;
    }
    fetch('https://apicars.p2p-cars.com/api/commande', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userEmail: userEmail,
        selectedRef: selectedRef
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        if (data.message === 'duplicate') {
          alert(translations[currentLang]['duplicate']);
          return;
        } else {
          alert("‚úÖ " + translations[currentLang]['commandeeffect']);
        }
      } else {
        alert("‚ö†Ô∏è " + (data.message || translations[currentLang]['resauerreur']));
      }
    })
    .catch(error => {
      alert("‚ö†Ô∏è " + translations[currentLang]['resauerreur']);
    });
    modalc.style.display = "none";
  };
  cancelBtn.onclick = function() {
    modalc.style.display = "none";
  };
  closeModalc.onclick = function() {
    modalc.style.display = "none";
  };
  const forum = document.getElementById("forum");
  const closeBtn = forum.querySelector(".close");
  document.getElementById("forum-title").innerText = translations[currentLang]['modal-forume'];
  document.getElementById("msg-title").innerText = translations[currentLang]['msg-title'];
  const Ref = (typeof car !== "undefined" && car.Ref) ? car.Ref : null;
  if (!Ref) console.error("Ref n'est pas d√©fini !");
  document.getElementById("forum-btn").onclick = function () {
    if (!Ref) {
        alert("Ref manquant. Impossible de charger le forum.");
        return;
    }
    forum.style.display = "flex";
    document.getElementById("forum-body").innerText = translations[currentLang]['titre-forum'];
    document.getElementById("forume-body").innerText = "Chargement forume...";
    fetch('https://apicars.p2p-cars.com/api/forume', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Ref })
    })
    .then(res => {
        if (!res.ok) throw new Error("Erreur r√©seau: " + res.status);
        return res.text();
    })
    .then(data => {
        document.getElementById("forume-body").innerHTML = data;
    })
    .catch(err => {
        document.getElementById("forume-body").innerText = "Erreur: " + err.message;
    });
  };
  closeBtn.onclick = () => forum.style.display = "none";
  window.onclick = (event) => {
    if (event.target === forum) forum.style.display = "none";
  };
  window.addEventListener('keydown', (e) => {
    if (e.key === "Escape") forum.style.display = "none";
  });
  new Swiper(".swiper", {
    loop: true,
    pagination: { el: ".swiper-pagination", clickable: true },
    navigation: { nextEl: ".swiper-button-next", prevEl: ".swiper-button-prev" }
  });
}
setLang('fr');
document.getElementById('btn').addEventListener('click', function() {
  window.location.href = 'https://p2p-cars.com/carservices';
});
</script>
</body>
</html>
