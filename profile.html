<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P-CARS - Profil</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #3b82f6;
      --blue-dark: #2563eb;
      --bg-input: #1e293b;
      --text: #e2e8f0;
      --muted: rgba(226,232,240,0.85);
      --error: #ff6b6b;
      --success: #34d399;
    }
    body {
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.301), rgba(30, 41, 59, 0.247)),
                  url('arier.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 { color: var(--blue); }
    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:0.92rem; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
    th { background: rgba(59,130,246,0.12); color:#fff; font-weight:600; }
    tr:hover { background: rgba(59,130,246,0.06); }
    .icon-btn { cursor:pointer; color:#ff6b6b; font-size:1rem; }
    .icon-btn:hover { color:#ff0000; }
  </style>
</head>
<body>
  <h1>Profil utilisateur</h1>
  <div>
    Connect√© en tant que : <span id="emailDisplay"></span>
    <button id="logoutBtn" style="margin-left:20px;">D√©connexion</button>
  </div>

  <div id="message" style="margin-top: 10px;"></div>

  <section id="results" style="display:none; margin-top: 20px;">
    <h2>Annonces</h2>
    <table id="table-annonces"></table>

    <h2>Achats</h2>
    <table id="table-achats"></table>

    <h2>Recherches</h2>
    <table id="table-recherches"></table>
  </section>

  <script>
    (function(){
      const API_LOGIN = 'https://apicars.p2p-cars.com/api/login';
      const API_DELETE = 'https://apicars.p2p-cars.com/api/deletitem';
      const messageBox = document.getElementById('message');
      const btnLogout = document.getElementById('logoutBtn');
      const emailDisplay = document.getElementById('emailDisplay');
      const resultsSection = document.getElementById('results');

      function showMessage(type, text) {
        messageBox.innerHTML = '';
        const el = document.createElement('div');
        el.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'black');
        el.textContent = text;
        messageBox.appendChild(el);
      }

      function remplirTableau(idTable, data) {
        const table = document.getElementById(idTable);
        table.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          table.innerHTML = '<tr><td>Aucune donn√©e</td></tr>';
          return;
        }

        // üîπ D√©terminer le type en fonction de l'idTable
        let typeExcel = '';
        if (idTable === 'table-annonces') typeExcel = 'annonce';
        if (idTable === 'table-achats') typeExcel = 'achat';
        if (idTable === 'table-recherches') typeExcel = 'recherche';

        const headers = ["Ref", "Date", "Marque", "Mod√®le", "Ann√©e", "CV", "Kilom√©trage", "Carburant", "Transmission", "Description", "Prix", "Valider", "Supprimer"];
        const thead = document.createElement('thead');
        const htr = document.createElement('tr');
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          htr.appendChild(th);
        });
        thead.appendChild(htr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        data.forEach((item, idx) => {
          const tr = document.createElement('tr');
          const id = item.id;
          const ref = (item.Ref && item.Ref.trim() !== '') ? item.Ref : `#${idx + 1}`;

          const cells = [
            ref,
            item.date || '',
            item.marque || '',
            item.modele || '',
            item.annee || '',
            item.cv || '',
            item.kilometrage || '',
            item.carburant || '',
            item.transmission || '',
            item.description || '',
            item.prix || '',
          ];

          cells.forEach(c => {
            const td = document.createElement('td');
            td.textContent = c;
            tr.appendChild(td);
          });

          // ‚úÖ Checkbox modification
          const tdValide = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = item.valide === 'oui' || item.valide === true;
          tdValide.appendChild(checkbox);
          tr.appendChild(tdValide);

          checkbox.addEventListener('change', async () => {
            const nouvelleValeur = checkbox.checked ? 'oui' : 'non';
            try {
              const resp = await fetch('https://apicars.p2p-cars.com/api/editdemande', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  id: id,
                  Ref: ref,
                  valide: nouvelleValeur,
                  table: typeExcel // üîπ Envoi du nom de l‚ÄôExcel
                })
              });
              if (!resp.ok) throw new Error('Erreur serveur');
              showMessage('success', `√âtat modifi√©: ${nouvelleValeur}`);
            } catch (err) {
              showMessage('error', 'Erreur lors de la modification.');
              checkbox.checked = !checkbox.checked;
            }
          });

          // ‚úÖ Suppression
          const tdDelete = document.createElement('td');
          const delIcon = document.createElement('i');
          delIcon.className = 'fa fa-trash icon-btn';
          delIcon.addEventListener('click', async () => {
            if (!confirm(`Supprimer l'√©l√©ment Ref: ${ref} ?`)) return;
            try {
              const resp = await fetch(API_DELETE, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  id: id,
                  Ref: ref,
                  table: typeExcel // üîπ Envoi du nom de l‚ÄôExcel
                })
              });
              if (!resp.ok) throw new Error('Erreur serveur');
              tr.remove();
              showMessage('success', `Ref ${ref} supprim√© avec succ√®s`);
            } catch (err) {
              showMessage('error', 'Erreur lors de la suppression.');
            }
          });
          tdDelete.appendChild(delIcon);
          tr.appendChild(tdDelete);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        resultsSection.style.display = 'block';
      }

      async function fetchProfile(email, password) {
        try {
          const resp = await fetch(API_LOGIN, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.message || 'Erreur serveur');

          emailDisplay.textContent = email;
          remplirTableau('table-annonces', data.annonces || []);
          remplirTableau('table-achats', data.achats || []);
          remplirTableau('table-recherches', data.recherches || []);
          showMessage('success', 'Donn√©es charg√©es');
        } catch(err) {
          showMessage('error', 'Session expir√©e, reconnectez-vous');
          setTimeout(() => window.location.href = '/login.html', 3000);
        }
      }

      btnLogout.addEventListener('click', () => {
        localStorage.removeItem('p2p_email');
        localStorage.removeItem('p2p_pwd');
        window.location.href = '/login.html';
      });

      window.addEventListener('DOMContentLoaded', () => {
        const email = localStorage.getItem('p2p_email');
        const pwdEncoded = localStorage.getItem('p2p_pwd');

        if (!email || !pwdEncoded) {
          showMessage('error', 'Non connect√©');
          setTimeout(() => window.location.href = '/login.html', 2000);
          return;
        }

        fetchProfile(email, atob(pwdEncoded));
      });

    })();
  </script>
</body>
</html>
