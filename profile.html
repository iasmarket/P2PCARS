<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P-CARS - Connexion</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #3b82f6;
      --blue-dark: #2563eb;
      --bg-input: #1e293b;
      --text: #e2e8f0;
      --muted: rgba(226,232,240,0.85);
      --error: #ff6b6b;
      --success: #34d399;
    }

    html,body{height:100%;}
    body {
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.301), rgba(30, 41, 59, 0.247)),
                url('arier.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 14px 10px 20px 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      gap: 40px;
    }
    header img { max-height:110px; transition:transform .25s; }
    header img:hover { transform: scale(1.05); }
    header h1 { font-size:2.4rem; color:var(--blue); margin:0; }
    header .text-h { color:var(--text); margin:0; }

    .form-section {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(11px);
      border-radius: 15px;
      max-width: 520px;
      margin: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.20);
      padding: 28px 22px;
      margin-bottom: 20px;
    }
    .form-section h2 { text-align:center; color:var(--blue); margin-top:0; }

    form label { display:block; font-weight:500; margin-bottom:6px; }
    input[type="email"], input[type="password"] {
      width:100%;
      padding:10px;
      border-radius:7px;
      border:1px solid #334155;
      background:var(--bg-input);
      color:var(--text);
      font-size:1rem;
      box-sizing:border-box;
    }
    input:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); border-color: var(--blue); }

    .input-error { border-color: var(--error) !important; box-shadow: none; }
    .error-text { color: var(--error); font-size:0.85rem; margin-top:6px; }
    .success-text { color: var(--success); font-size:0.95rem; margin-top:6px; }

    .checkbox-container {
      display:flex; align-items:center; gap:10px;
      font-size:0.95rem; cursor:pointer; user-select:none; margin-top:8px;
    }
    .checkbox-container input[type="checkbox"] {
      appearance:none; width:18px; height:18px; border:2px solid var(--blue);
      border-radius:4px; position:relative; cursor:pointer; background:transparent;
    }
    .checkbox-container input[type="checkbox"]:checked {
      background:var(--blue); border-color:var(--blue);
    }
    .checkbox-container input[type="checkbox"]:checked::after{
      content:"\2713"; position:absolute; left:3px; top:-1px; color:#fff; font-size:12px;
    }
    .checkbox-container:hover input[type="checkbox"]{ border-color:var(--blue-dark); }

    button[type="submit"]{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--blue); color:#fff; border:none; padding:10px 18px; border-radius:7px;
      font-weight:600; cursor:pointer; margin-top:12px; font-size:1rem;
    }
    button[disabled]{ opacity:0.7; cursor:not-allowed; }

    /* spinner */
    .spinner {
      width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.35);
      border-top-color: #fff; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #message { margin-top:12px; text-align:center; min-height:20px; }
    #message .text { display:inline-block; padding:8px 12px; border-radius:8px; font-weight:600; }

    #results { max-width:95%; margin:auto; display:none; }

    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:0.92rem; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
    th { background: rgba(59,130,246,0.12); color:#fff; font-weight:600; }
    tr:hover { background: rgba(59,130,246,0.06); }

    /* small helpers */
    .muted { color:var(--muted); font-size:0.92rem; text-align:center; margin-top:10px; }
    @media (max-width:720px){
      header { flex-direction:column; text-align:center; gap:12px; }
      .form-section{ margin:12px; padding:18px; }
    }
  </style>
</head>
<body>
  <h1>Profil utilisateur</h1>
  <div>
    Connect√© en tant que : <span id="emailDisplay"></span>
    <button id="logoutBtn" style="margin-left:20px;">D√©connexion</button>
  </div>

  <div id="message" style="margin-top: 10px;"></div>

  <section id="results" style="display:none; margin-top: 20px;">
    <h2>Annonces</h2>
    <table id="table-annonces" border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse: collapse;"></table>

    <h2>Achats</h2>
    <table id="table-achats" border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse: collapse;"></table>

    <h2>Recherches</h2>
    <table id="table-recherches" border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse: collapse;"></table>
  </section>

  <script>
    (function(){
      const API_LOGIN = 'https://apicars.p2p-cars.com/api/login';
      const messageBox = document.getElementById('message');
      const btnLogout = document.getElementById('logoutBtn');
      const emailDisplay = document.getElementById('emailDisplay');
      const resultsSection = document.getElementById('results');

      function showMessage(type, text) {
        messageBox.innerHTML = '';
        const el = document.createElement('div');
        el.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'black');
        el.textContent = text;
        messageBox.appendChild(el);
      }

function remplirTableau(idTable, data, userId) {
  const table = document.getElementById(idTable);
  table.innerHTML = '';

  if (!Array.isArray(data) || data.length === 0) {
    table.innerHTML = '<tr><td colspan="13">Aucune donn√©e disponible</td></tr>';
    return;
  }

  // En-t√™tes
  const headers = [
    "Ref", "Date", "Marque", "Mod√®le", "Ann√©e", "CV", "Kilom√©trage",
    "Carburant", "Transmission", "Description", "Prix", "Valide", "Supprimer"
  ];

  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headers.forEach(h => {
    const th = document.createElement('th');
    th.textContent = h;
    headerRow.appendChild(th);
  });
  thead.appendChild(headerRow);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');

  data.forEach((item, idx) => {
    const tr = document.createElement('tr');

    // Colonnes de donn√©es (sauf Supprimer)
    const cells = [
      item.Ref || `#${idx + 1}`,
      item.Date || item.date || '',
      item.Marque || item.marque || '',
      item.Mod√®le || item.modele || '',
      item.Ann√©e || item.annee || '',
      item.CV || item.cv || '',
      item.Kilom√©trage || item.kilometrage || '',
      item.Carburant || item.carburant || '',
      item.Transmission || item.transmission || '',
      item.Description || item.description || '',
      item.Prix || item.prix || '',
      item.Valide || item.valide ? 'Oui' : 'Non'
    ];

    cells.forEach(text => {
      const td = document.createElement('td');
      td.textContent = text;
      tr.appendChild(td);
    });

    // Bouton corbeille
    const tdDelete = document.createElement('td');
    const btnDelete = document.createElement('button');
    btnDelete.innerHTML = 'üóëÔ∏è';
    btnDelete.title = 'Supprimer cette ligne';
    btnDelete.style.cursor = 'pointer';
    btnDelete.style.border = 'none';
    btnDelete.style.background = 'transparent';
    btnDelete.style.fontSize = '1.2em';

    btnDelete.addEventListener('click', async () => {
      if (!confirm(`Voulez-vous vraiment supprimer la ligne Ref: ${item.Ref}?`)) return;

      try {
        const response = await fetch('https://apicars.p2p-cars.com/api/deletitem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: userId, Ref: item.Ref })
        });
        const result = await response.json();

        if (response.ok && result.success) {
          alert('Ligne supprim√©e avec succ√®s');
          tr.remove();
        } else {
          alert('Erreur lors de la suppression : ' + (result.message || 'Erreur serveur'));
        }
      } catch (err) {
        alert('Erreur r√©seau, impossible de supprimer');
      }
    });

    tdDelete.appendChild(btnDelete);
    tr.appendChild(tdDelete);

    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
}

      async function fetchProfile(email, password) {
        try {
          const resp = await fetch(API_LOGIN, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.message || 'Erreur serveur');

          emailDisplay.textContent = email;
          remplirTableau('table-annonces', data.annonces, data.id);
          remplirTableau('table-achats', data.achats, data.id);
          remplirTableau('table-recherches', data.recherches, data.id);


          showMessage('success', 'Donn√©es charg√©es');
        } catch(err) {
          showMessage('error', 'Session expir√©e, reconnectez-vous');
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 3000);
        }
      }

      btnLogout.addEventListener('click', () => {
        localStorage.removeItem('p2p_email');
        localStorage.removeItem('p2p_pwd');
        window.location.href = '/login.html';
      });

      window.addEventListener('DOMContentLoaded', () => {
        const email = localStorage.getItem('p2p_email');
        const pwdEncoded = localStorage.getItem('p2p_pwd');

        if (!email || !pwdEncoded) {
          showMessage('error', 'Non connect√©');
          setTimeout(() => window.location.href = '/login.html', 2000);
          return;
        }

        fetchProfile(email, atob(pwdEncoded));
      });

    })();
  </script>
</body>

</html>
