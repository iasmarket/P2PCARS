<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P-CARS - Connexion</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #3b82f6;
      --blue-dark: #2563eb;
      --bg-input: #1e293b;
      --text: #e2e8f0;
      --muted: rgba(226,232,240,0.85);
      --error: #ff6b6b;
      --success: #34d399;
    }

    html, body { height: 100%; margin: 0; padding: 0; }
    body {
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.301), rgba(30, 41, 59, 0.247)),
                  url('arier.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      font-family: 'Poppins', sans-serif;
    }

    header {
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 14px 10px 20px 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      gap: 40px;
    }
    header img { max-height:110px; transition:transform .25s; }
    header img:hover { transform: scale(1.05); }
    header h1 { font-size:2.4rem; color:var(--blue); margin:0; }
    header .text-h { color:var(--text); margin:0; }

    .form-section {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(11px);
      border-radius: 15px;
      max-width: 520px;
      margin: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.20);
      padding: 28px 22px;
      margin-bottom: 20px;
    }
    .form-section h2 { text-align:center; color:var(--blue); margin-top:0; }

    form label { display:block; font-weight:500; margin-bottom:6px; }
    input[type="email"], input[type="password"] {
      width:100%;
      padding:10px;
      border-radius:7px;
      border:1px solid #334155;
      background:var(--bg-input);
      color:var(--text);
      font-size:1rem;
      box-sizing:border-box;
    }
    input:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); border-color: var(--blue); }

    .input-error { border-color: var(--error) !important; box-shadow: none; }
    .error-text { color: var(--error); font-size:0.85rem; margin-top:6px; }
    .success-text { color: var(--success); font-size:0.95rem; margin-top:6px; }

    .checkbox-container {
      display:flex; align-items:center; gap:10px;
      font-size:0.95rem; cursor:pointer; user-select:none; margin-top:8px;
    }
    .checkbox-container input[type="checkbox"] {
      appearance:none; width:18px; height:18px; border:2px solid var(--blue);
      border-radius:4px; position:relative; cursor:pointer; background:transparent;
    }
    .checkbox-container input[type="checkbox"]:checked {
      background:var(--blue); border-color:var(--blue);
    }
    .checkbox-container input[type="checkbox"]:checked::after{
      content:"\2713"; position:absolute; left:3px; top:-1px; color:#fff; font-size:12px;
    }
    .checkbox-container:hover input[type="checkbox"]{ border-color:var(--blue-dark); }

    button[type="submit"]{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--blue); color:#fff; border:none; padding:10px 18px; border-radius:7px;
      font-weight:600; cursor:pointer; margin-top:12px; font-size:1rem;
      transition: background-color 0.3s ease;
    }
    button[type="submit"]:hover:not([disabled]) {
      background: var(--blue-dark);
    }
    button[disabled]{ opacity:0.7; cursor:not-allowed; }

    /* spinner */
    .spinner {
      width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.35);
      border-top-color: #fff; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #message { margin-top:12px; text-align:center; min-height:20px; }
    #message .text { display:inline-block; padding:8px 12px; border-radius:8px; font-weight:600; }

    #results { max-width:95%; margin:auto; display:none; }

    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:0.92rem; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
    th { background: rgba(59,130,246,0.12); color:#fff; font-weight:600; }
    tr:hover { background: rgba(59,130,246,0.06); }

    /* small helpers */
    .muted { color:var(--muted); font-size:0.92rem; text-align:center; margin-top:10px; }
    @media (max-width:720px){
      header { flex-direction:column; text-align:center; gap:12px; }
      .form-section{ margin:12px; padding:18px; }
    }
  </style>
</head>
<body>
  <h1>Connexion</h1>

  <form id="loginForm" novalidate>
    <label for="email">Email :</label><br>
    <input type="email" id="email" name="email" required>
    <div id="emailError" class="error-text"></div><br>

    <label for="password">Mot de passe :</label><br>
    <input type="password" id="password" name="password" required minlength="4">
    <div id="passwordError" class="error-text"></div><br>

    <label class="checkbox-container">
      <input type="checkbox" id="rememberMe" checked>
      Se souvenir de moi
    </label><br><br>

    <button id="submitBtn" type="submit">
      <span id="btnContent"><i class="fas fa-sign-in-alt"></i> Se connecter</span>
    </button>
  </form>

  <div id="message"></div>

  <p>
    <a href="#" id="forgotPassword" style="cursor:pointer; color:blue; text-decoration:underline;">Mot de passe oublié ?</a>
  </p>

  <script>
    (function () {
      const API_URL = 'https://apicars.p2p-cars.com/api/login';
      const REST_URL = 'https://apicars.p2p-cars.com/api/loginrest';

      const form = document.getElementById('loginForm');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const rememberInput = document.getElementById('rememberMe');
      const submitBtn = document.getElementById('submitBtn');
      const btnContent = document.getElementById('btnContent');
      const messageBox = document.getElementById('message');
      const emailError = document.getElementById('emailError');
      const passwordError = document.getElementById('passwordError');
      const forgotPasswordLink = document.getElementById('forgotPassword');

      function showMessage(type, text) {
        messageBox.innerHTML = '';
        if (!text) return;
        const el = document.createElement('div');
        el.className = 'text';
        el.style.color = type === 'error' ? 'var(--error)' : (type === 'success' ? 'var(--success)' : 'var(--text)');
        el.textContent = text;
        messageBox.appendChild(el);
      }

      function clearFieldErrors() {
        emailError.textContent = '';
        passwordError.textContent = '';
        emailInput.classList.remove('input-error');
        passwordInput.classList.remove('input-error');
      }

      function setFieldError(inputEl, errorEl, message) {
        inputEl.classList.add('input-error');
        errorEl.textContent = message;
      }

      function setLoading(isLoading) {
        if (isLoading) {
          submitBtn.disabled = true;
          btnContent.innerHTML = '<span class="spinner" aria-hidden="true"></span> Connexion…';
        } else {
          submitBtn.disabled = false;
          btnContent.innerHTML = '<i class="fas fa-sign-in-alt"></i> Se connecter';
        }
      }

      // Vérifie si session active en localStorage
      window.addEventListener('DOMContentLoaded', () => {
        const savedEmail = localStorage.getItem('p2p_email');
        const savedPwd = localStorage.getItem('p2p_pwd');
        if (savedEmail && savedPwd) {
          // Redirection si connecté
          window.location.href = 'profile.html';
        } else if (savedEmail) {
          emailInput.value = savedEmail;
        }
      });

      forgotPasswordLink.addEventListener('click', async (e) => {
        e.preventDefault();
        clearFieldErrors();
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showMessage('error', 'Entrez un email valide pour réinitialiser votre mot de passe.');
          return;
        }
        showMessage('info', 'Envoi de la demande de réinitialisation...');
        try {
          const response = await fetch(REST_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email })
          });
          if (!response.ok) throw new Error('Erreur lors de l\'envoi de la demande');
          showMessage('success', 'Email de réinitialisation envoyé ✅');
        } catch {
          showMessage('error', 'Erreur lors de l\'envoi de la demande, réessayez.');
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearFieldErrors();
        showMessage('info', ''); // vider message global

        const email = emailInput.value.trim();
        const password = passwordInput.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        let hasError = false;

        if (!emailRegex.test(email)) {
          setFieldError(emailInput, emailError, 'Adresse email invalide');
          hasError = true;
        }
        if (!password || password.length < 4) {
          setFieldError(passwordInput, passwordError, 'Mot de passe trop court (min 4 caractères)');
          hasError = true;
        }
        if (hasError) {
          showMessage('error', 'Corrigez les erreurs ci-dessus avant d’envoyer.');
          return;
        }

        setLoading(true);
        showMessage('info', 'Connexion en cours...');

        try {
          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });

          if (!response.ok) {
            let errMsg = `Erreur serveur (${response.status})`;
            try {
              const errJson = await response.json();
              errMsg = errJson.message || errJson.error || errMsg;
            } catch {}

            if (response.status === 401) {
              showMessage('error', 'Identifiants incorrects — vérifiez votre email/mot de passe.');
            } else {
              showMessage('error', errMsg);
            }
            setLoading(false);
            return;
          }

          // Connexion réussie : stocker email et pwd (encodé) si "se souvenir"
          if (rememberInput.checked) {
            localStorage.setItem('p2p_email', email);
            localStorage.setItem('p2p_pwd', btoa(password));
          } else {
            localStorage.removeItem('p2p_email');
            localStorage.removeItem('p2p_pwd');
          }

          showMessage('success', 'Connexion réussie ✅');
          setLoading(false);

          // Redirection vers profile
          window.location.href = 'https://p2p-cars.com/profile';

        } catch {
          showMessage('error', 'Erreur réseau — impossible de contacter le serveur.');
          setLoading(false);
        }
      });

    })();
  </script>
</body>
</html>
