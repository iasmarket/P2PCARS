const express = require('express');
const cors = require('cors');
const path = require('path');
const fs = require('fs');
const xlsx = require('xlsx');
const XLSX = require('xlsx');

const multer = require('multer');
const nodemailer = require('nodemailer');
const app = express();
require('dotenv').config();
const chokidar = require('chokidar'); // ‚Üê CommonJS
const { execSync } = require('child_process');

const corsOptions = {
  origin: [
    'https://p2p-cars.com',
    'https://apicars.p2p-cars.com'
  ],
  methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
  allowedHeaders: ["Content-Type", "Authorization"],
  credentials: true,
  optionsSuccessStatus: 200
};

// CORS en premier
app.use(cors(corsOptions));
app.options('*', cors(corsOptions));

// Parse JSON bodies
app.use(express.json());

// D√©finitions des chemins
const dataDir = path.join('D:/Projet P2P-Cars', 'data');
const usersExcelFile = path.join(dataDir, 'users.xlsx');
const annonceExcelFile = path.join(dataDir, 'Nannonce.xlsx');
const achatExcelFile = path.join(dataDir, 'Ncommand.xlsx');
const rechercheExcelFile = path.join(dataDir, 'NRecherche.xlsx');


const GITHUB_TOKEN = process.env.GITHUB_TOKEN; // ton token
const REPO = 'iasmarket/p2PCARS'; // repo GitHub
const imagesDir = path.join(dataDir, 'datatof');
const idDir = path.join(dataDir, 'dataid');
const msgDir = path.join(dataDir, 'forumes');
const GENERATED_DIR = path.join(dataDir, 'generatedjs'); // dossier racine repo

// Fonction utilitaire cr√©ation dossier
function ensureDirExists(dirPath) {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
    console.log(`[UTIL] Cr√©ation dossier : ${dirPath}`);
  }
}
// Cr√©ation des dossiers au d√©marrage
for (const dir of [dataDir, imagesDir, idDir]) {
  ensureDirExists(dir);
}

app.use('/images', express.static(imagesDir));
app.use('/ids', express.static(idDir));


// Headers colonnes Excel
const ANNONCE_HEADERS = [
   "id","passwords", "telephone", "cin","cin_img","Ref","date", "marque", "modele", "annee","cv", "prix", "kilometrage",
  "carburant", "transmission", "description","images",  "cartegrise_recto", "cartegrise_verso", "procuration","ville","valide",
];
const ACHAT_HEADERS = [
  "id","passwords", "telephone", "cin","cin_img","Ref","date", "marque", "modele", "annee","cv", "prix", "kilometrage",
  "carburant", "transmission", "description", "images","ville","valide",
];
const RECHERCHE_HEADERS = [
  "id","passwords", "telephone", "cin","cin_img","Ref","date", "marque", "modele", "annee","cv", "prix", "kilometrage",
  "carburant", "transmission", "description", "images","ville","valide"
];
const users_HEADERS = [
  "id","passwords", "telephone", "cin","appels","imgcin","nom","datentre","datdernvisit","nbrvisit","comport","n√©goce"
];
const msgs_HEADERS = [
  "idby","Nom","time", "prixoffre","Message"
];

// V√©rifie et cr√©e dossier parent pour fichier donn√©
function ensureDirectoryExistence(filePath) {
  const dir = path.dirname(filePath);
  ensureDirExists(dir);
}
// Fonction generate password Excel
function generatePassword(length) {
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+';
  let password = '';
  for (let i = 0; i < length; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return password;
}

function verifierValeurs(filePath, col1, col2, val1, val2) {
    const workbook = xlsx.readFile(filePath);
    const sheetName = workbook.SheetNames[0]; // On prend la premi√®re feuille
    const sheet = workbook.Sheets[sheetName];
    const data = xlsx.utils.sheet_to_json(sheet);

    for (let row of data) {
        if (row[col1] === val1 && row[col2] === val2) {
            return "oui";
        }
    }

    return "non";
}
// extraire une ligne selon son id
function getCommandeById(filePath, col, id, headers) { 
  const workbook = xlsx.readFile(filePath);
  const sheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[sheetName];

  const data = xlsx.utils.sheet_to_json(worksheet);

  // Chercher la ligne correspondant √† l'ID dans la colonne 'col'
  const ligne = data.find(row => row[col] === id);

  if (!ligne) {
    console.log(`Aucune commande trouv√©e pour ${col} = ${id}`);
    return null;
  }

  // Cr√©er la constante en ne gardant que les headers sp√©cifi√©s
  const commande = {};
  headers.forEach(header => {
    commande[header] = ligne[header] !== undefined ? ligne[header] : null;
  });

  return commande;
}


// Fonction chercher id update delet lignes Excel

// V√©rifier si ID existe
//console.log(checkAndUpdateExcel("data.xlsx", "123")); // ‚Üí "oui" ou "non"

// Supprimer si trouv√©
//checkAndUpdateExcel("data.xlsx", "123", "delete");

// Modifier seulement la colonne "status"
//checkAndUpdateExcel("data.xlsx", "123", "update", "status", "valid√©");

// R√©cup√©rer la valeur de la colonne "password" pour un ID donn√©
//let motDePasse = checkAndUpdateExcel("data.xlsx", "aliance-21", "get", "password");

//pour suppression conditionnelle avec Ref :
//checkAndUpdateExcel("data.xlsx", "123", "delete", null, "20250809");

//pour r√©cup√©rer un id √† partir d‚Äôun Ref
//const id = checkAndUpdateExcel(file, null, "getIdByRef", "Ref", refValue);

function checkAndUpdateExcel(file, id, action = "check", columnName = null, newValue = null) {
  if (!fs.existsSync(file)) {
    console.log("‚ùå Fichier introuvable :", file);
    return "non";
  }

  const workbook = xlsx.readFile(file);
  const worksheet = workbook.Sheets[workbook.SheetNames[0]];
  let sheetData = xlsx.utils.sheet_to_json(worksheet, { header: 1 });

  if (sheetData.length < 2) {
    console.log("‚ö†Ô∏è Aucun enregistrement trouv√©.");
    return "non";
  }

  const headers = sheetData[0];
  const idIndex = headers.indexOf("id");

  if (idIndex === -1) {
    console.log("‚ùå Colonne 'id' introuvable.");
    return "non";
  }

  let foundIndex = -1;
  for (let i = 1; i < sheetData.length; i++) {
    if (String(sheetData[i][idIndex]) === String(id)) {
      foundIndex = i;
      break;
    }
  }

  if (foundIndex === -1) {
    return "non";
  }

  if (action === "get" && columnName) {
    const colIndex = headers.indexOf(columnName);
    if (colIndex === -1) {
      console.log(`‚ùå Colonne '${columnName}' introuvable.`);
      return "non";
    }
    return sheetData[foundIndex][colIndex] || "";
  }





if (action === "delete") {
  // Trouver l'index de la colonne 'Ref'
  const refIndex = headers.indexOf("Ref");
  if (refIndex === -1) {
    console.log("‚ùå Colonne 'Ref' introuvable.");
    return "non";
  }

  // Supprimer la ligne o√π id ET Ref correspondent
  for (let i = 1; i < sheetData.length; i++) {
    if (String(sheetData[i][idIndex]) === String(id) && String(sheetData[i][refIndex]) === String(newValue)) {
      sheetData.splice(i, 1);
      const newSheet = xlsx.utils.aoa_to_sheet(sheetData);
      workbook.Sheets[workbook.SheetNames[0]] = newSheet;
      xlsx.writeFile(workbook, file);
      console.log(`üóë Ligne avec ID ${id} et Ref ${newValue} supprim√©e.`);
      return "oui";
    }
  }
  // Si aucune ligne trouv√©e
  console.log(`‚ö†Ô∏è Aucune ligne trouv√©e avec ID ${id} et Ref ${newValue}.`);
  return "non";
}


  if (action === "update" && columnName) {
    const colIndex = headers.indexOf(columnName);
    if (colIndex === -1) {
      console.log(`‚ùå Colonne '${columnName}' introuvable.`);
      return "non";
    }
    sheetData[foundIndex][colIndex] = newValue;
    const newSheet = xlsx.utils.aoa_to_sheet(sheetData);
    workbook.Sheets[workbook.SheetNames[0]] = newSheet;
    xlsx.writeFile(workbook, file);
    console.log(`‚úè Colonne '${columnName}' de l'ID ${id} mise √† jour √† '${newValue}'.`);
    return "oui";
  }

  if (action === "check") {
    return "oui";
  }

  return "non";
}
// Fonction sauvegarde Excel
function saveToExcel(file, headers, data) {
  ensureDirectoryExistence(file);
  let workbook, worksheet;

  if (fs.existsSync(file)) {
    workbook = xlsx.readFile(file);
    worksheet = workbook.Sheets[workbook.SheetNames[0]];
    const sheetData = xlsx.utils.sheet_to_json(worksheet, { header: 1 });
    if (!sheetData.length) {
      worksheet = xlsx.utils.aoa_to_sheet([headers]);
      workbook.Sheets[workbook.SheetNames[0]] = worksheet;
    }
  } else {
    workbook = xlsx.utils.book_new();
    worksheet = xlsx.utils.aoa_to_sheet([headers]);
    xlsx.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
  }

  const row = headers.map(h => data[h] || "");
  xlsx.utils.sheet_add_aoa(worksheet, [row], { origin: -1 });
  xlsx.writeFile(workbook, file);
  console.log(`[EXCEL] Donn√©es enregistr√©es dans ${file} :`, row);
}

// Multer stockage avec cr√©ation dossier dynamique
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    const idFields = ['cin_img', 'cartegrise', 'procuration'];
    const dest = idFields.includes(file.fieldname) ? idDir : imagesDir;
    ensureDirExists(dest);
    console.log(`[MULTER] Fichier ${file.originalname} pour champ ${file.fieldname} dirig√© vers ${dest}`);
    cb(null, dest);
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random()*1E9);
    const filename = uniqueSuffix + path.extname(file.originalname);
    console.log(`[MULTER] Nouveau fichier: ${filename}`);
    cb(null, filename);
  }
});

const uploadAnnonce = multer({ storage, limits: { files: 20 } }).fields([
  { name: 'images', maxCount: 10 },
  { name: 'cin_img', maxCount: 4 },
  { name: 'cartegrise', maxCount: 2 },
  { name: 'procuration', maxCount: 2 }
]);
const uploadAchat = multer({ storage, limits: { files: 15 } }).fields([
  { name: 'images', maxCount: 10 },
  { name: 'cin_img', maxCount: 4 }
]);
const uploadRecherche = multer({ storage, limits: { files: 15 } }).fields([
  { name: 'images', maxCount: 10 },
  { name: 'cin_img', maxCount: 4 }
]);
//date en ref

function dateToInteger(dateInput) {
  let date = new Date(dateInput); // accepte une string ISO ou un objet Date

  let year = date.getUTCFullYear().toString();
  let month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
  let day = date.getUTCDate().toString().padStart(2, '0');
  let hours = date.getUTCHours().toString().padStart(2, '0');
  let minutes = date.getUTCMinutes().toString().padStart(2, '0');
  let seconds = date.getUTCSeconds().toString().padStart(2, '0');
  let milliseconds = date.getUTCMilliseconds().toString().padStart(3, '0');

  return "P2P-Cars"+year + month + day + hours + minutes + seconds + milliseconds;
}

// Routes API

// 1. POST /api/annonce
app.post('/api/annonce', async(req, res) => {
  uploadAnnonce(req, res, async(err) => {
    if (err) {
      console.error("[ERREUR] Multer annonce :", err);
      return res.status(400).json({success:false, message: "Erreur upload images"});
    }
    try {
      console.log("[API] POST /api/annonce re√ßu !");
      const fields = req.body;
      const files = req.files || {};
      console.log("[API] Champs re√ßus :", fields);
      console.log("[API] Fichiers re√ßus :", Object.keys(files));

      const images = (files.images || []).map(f => path.relative(dataDir, f.path));
      const cin_imgs = (files.cin_img || []).map(f => path.relative(dataDir, f.path));
      const cartegrises = (files.cartegrise || []).map(f => path.relative(dataDir, f.path));
      const cartegrise_recto = cartegrises[0] || "";
      const cartegrise_verso = cartegrises[1] || "";
      const procurations = (files.procuration || []).map(f => path.relative(dataDir, f.path));
      const procuration = procurations[0] || "";

      const logg =fields.email.trim().toLowerCase();
      let checkpass="";
      if (checkAndUpdateExcel(usersExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(usersExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(annonceExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(annonceExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(achatExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(achatExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(rechercheExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(rechercheExcelFile, logg,"get", "passwords"));
      }else{
        checkpass=generatePassword(8);
      }
      
      const annonce = {
        id: fields.email.trim().toLowerCase(),
        passwords:checkpass,
        telephone: fields.telephone,
        cin: fields.cin,
        cin_img: cin_imgs.join(";"),
        Ref :dateToInteger(new Date().toISOString()),
        date: new Date().toISOString(),
        marque: fields.marque,
        modele: fields.modele,
        annee: fields.annee,
        cv : fields.puissancefiscal,
        prix: fields.prix,
        kilometrage: fields.kilometrage,
        carburant: fields.carburant,
        transmission: fields.transmission,
        description: fields.description+" de "+ fields.ville,
        images: images.join(";"),
        cartegrise_recto,
        cartegrise_verso,
        procuration,
        valide:"non",
        ville:fields.ville
      };
      
      saveToExcel(annonceExcelFile, ANNONCE_HEADERS, annonce);
      let gciin;
      if (checkAndUpdateExcel(usersExcelFile, logg)!=="oui"){
        const usdta = {
          id: fields.email.trim().toLowerCase(),
          passwords:checkpass,
          telephone: fields.telephone,
          cin: fields.cin,
          appels:"non",
          imgcin:cin_imgs.join(";"),
          nom:"",
          datentre:new Date().toISOString(),
          datdernvisit:new Date().toISOString(),
          nbrvisit:1,
          comport:"",
          n√©goce:""
        };
        saveToExcel(usersExcelFile, users_HEADERS, usdta );
        
      }else {
        gciin=checkAndUpdateExcel(usersExcelFile, fields.email.trim().toLowerCase(), "get", "imgcin");
        if (gciin.trim() === ""){
         checkAndUpdateExcel(usersExcelFile,fields.email.trim().toLowerCase(), "update", "imgcin", cin_imgs.join(";"));
        }
      }
      res.json({ success: true, message: "Annonce enregistr√©e" });
      const dat = {
        introduction:" ‚úÖ Nous avons bien re√ßu votre demande d‚Äôannonce pour la vente de votre v√©hicule. Vous trouverez les d√©tails ci-dessous : ",
        Email: annonce.id,
        password: "Mot de passe :"+annonce.passwords,
        reff: "r√©f√©rence "+annonce.Ref,
        objet: "Demande de mise en ligne d‚Äôannonce de voiture d‚Äôoccasion",
        Marque: "Voiture "+annonce.marque,
        Modele: ", mod√®le "+annonce.modele,
        cv: ", puissance fiscale "+annonce.cv,
        carburant: " CV, carburant "+annonce.carburant,
        anne: ", mise en circulation en "+annonce.annee,
        message: "Vous pouvez vous connecter via l‚Äôespace suivant : https://p2p-cars.com/login et cocher la mise en ligne de votre annonce afin qu‚Äôelle soit visible aux acheteurs. Notre √©quipe v√©rifiera les informations et vous contactera rapidement pour toute demande d‚Äôachat s√©rieuse. Merci de votre confiance !"
      };
      const result = await sendEmail(dat);
      if (!result.success) {
        checkAndUpdateExcel(annonceExcelFile, annonce.id, "delete", null, annonce.Ref);
        console.error("Envoi email √©chou√©", result.error);
      }     
    } catch (err) {
      console.error("[ERREUR] POST /api/annonce :", err);
      res.status(500).json({ success: false, message: "Erreur lors de l'enregistrement de l'annonce" });
    }
  });
});

// 2. POST /api/achat
app.post('/api/achat', async(req, res) => {
  uploadAchat(req, res, async(err) => {
    if (err) {
      console.error("[ERREUR] Multer achat :", err);
      return res.status(400).json({success:false, message: "Erreur upload images"});
    }
    try {
      console.log("[API] POST /api/achat re√ßu !");
      const fields = req.body;
      const files = req.files || {};
      console.log("[API] Champs re√ßus :", fields);
      console.log("[API] Fichiers re√ßus :", Object.keys(files));

      const images = (files.images || []).map(f => path.relative(dataDir, f.path));
      const cin_imgs = (files.cin_img || []).map(f => path.relative(dataDir, f.path));

      const logg =fields.email.trim().toLowerCase();
      let checkpass="";
      if (checkAndUpdateExcel(usersExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(usersExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(annonceExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(annonceExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(achatExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(achatExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(rechercheExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(rechercheExcelFile, logg,"get", "passwords"));
      }else{
        checkpass=generatePassword(8);
      }

      const achat = {
        
        id: fields.email.trim().toLowerCase(),
        passwords:checkpass,
        telephone: fields.telephone,
        cin: fields.cin,
        cin_img: cin_imgs.join(";"),
        Ref :dateToInteger(new Date().toISOString()),
        date: new Date().toISOString(),
        marque: fields.marque,
        modele: fields.modele,
        annee: fields.annee,
        cv : fields.puissancefiscal,
        prix: fields.prix,
        kilometrage: fields.kilometrage,
        carburant: fields.carburant,
        transmission: fields.transmission,
        description: fields.description+" de "+fields.ville,
        images: images.join(";"),
        valide:"non",
        ville:fields.ville
      };
      let gciin;
      if (checkAndUpdateExcel(usersExcelFile, logg)!=="oui"){
        const usdta = {
          id: fields.email.trim().toLowerCase(),
          passwords:checkpass,
          telephone: fields.telephone,
          cin: fields.cin,
          appels:"non",
          imgcin:cin_imgs.join(";"),
          nom:"",
          datentre:new Date().toISOString(),
          datdernvisit:new Date().toISOString(),
          nbrvisit:1,
          comport:"",
          n√©goce:""
        };
        saveToExcel(usersExcelFile, users_HEADERS, usdta );
        
      }else {
        gciin=checkAndUpdateExcel(usersExcelFile, fields.email.trim().toLowerCase(), "get", "imgcin");
        if (gciin.trim() === ""){
         checkAndUpdateExcel(usersExcelFile,fields.email.trim().toLowerCase(), "update", "imgcin", cin_imgs.join(";"));
        }
      }
      res.json({ success: true, message: "Demande d'achat enregistr√©e" });
      const dat = {
        introduction:"‚úÖ Nous avons bien re√ßu votre demande d‚Äôachat de v√©hicule. Vous trouverez les d√©tails ci-dessous :",
        Email: achat.id,
        password: "Mot de passe :"+achat.passwords,
        reff: "r√©f√©rence "+achat.Ref,
        objet: "Demande d‚Äôaccompagnement pour achat de voiture d‚Äôoccasion",
        Marque: "Voiture "+achat.marque,
        Modele: ", mod√®le "+achat.modele,
        cv: ", puissance fiscale "+achat.cv,
        carburant: " CV, carburant "+achat.carburant,
        anne: ", mise en circulation en "+achat.annee,
        message: "Vous pouvez vous connecter via l‚Äôespace suivant : https://p2p-cars.com/login et cocher la mise en ligne de votre demande afin qu‚Äôelle soit visible aux vendeurs. Notre √©quipe v√©rifiera les informations, et un conseiller vous contactera rapidement par t√©l√©phone pour finaliser les d√©tails et vous accompagner dans votre projet d‚Äôachat. Merci de votre confiance !"
      };
      const result = await sendEmail(dat);
      if (!result.success) {
        checkAndUpdateExcel(achatExcelFile, achat.id, "delete", null, achat.Ref);
        console.error("Envoi email √©chou√©", result.error);
      }
    } catch (err) {
      console.error("[ERREUR] POST /api/achat :", err);
      res.status(500).json({ success: false, message: "Erreur lors de l'enregistrement de la commande" });
    }
  });
});

// 3. POST /api/rechercher
app.post('/api/rechercher', async(req, res) => {
  uploadRecherche(req, res, async(err) => {
    if (err) {
      console.error("[ERREUR] Multer recherche :", err);
      return res.status(400).json({success:false, message: "Erreur upload images"});
    }
    try {
      console.log("[API] POST /api/rechercher re√ßu !");
      const fields = req.body;
      const files = req.files || {};
      console.log("[API] Champs re√ßus :", fields);
      console.log("[API] Fichiers re√ßus :", Object.keys(files));

      const images = (files.images || []).map(f => path.relative(dataDir, f.path));
      const cin_imgs = (files.cin_img || []).map(f => path.relative(dataDir, f.path));

      const logg =fields.email.trim().toLowerCase();
      let checkpass="";
      if (checkAndUpdateExcel(usersExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(usersExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(annonceExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(annonceExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(achatExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(achatExcelFile, logg,"get", "passwords"));
      }else if (checkAndUpdateExcel(rechercheExcelFile, logg)==="oui"){
        checkpass=(checkAndUpdateExcel(rechercheExcelFile, logg,"get", "passwords"));
      }else{
        checkpass=generatePassword(8);
      }

      const recherche = {
        id: fields.email.trim().toLowerCase(),
        passwords:checkpass,
        telephone: fields.telephone,
        cin: fields.cin,
        cin_img: cin_imgs.join(";"),
        Ref :dateToInteger(new Date().toISOString()),
        date: new Date().toISOString(),
        marque: fields.marque,
        modele: fields.modele,
        annee: fields.annee,
        cv : fields.puissancefiscal,
        prix: fields.prix,
        kilometrage: fields.kilometrage,
        carburant: fields.carburant,
        transmission: fields.transmission,
        description: fields.description+" de "+fields.ville,
        images: images.join(";"),
        valide:"non",
        ville:fields.ville
      };

      saveToExcel(rechercheExcelFile, RECHERCHE_HEADERS, recherche);
      let gciin;
      if (checkAndUpdateExcel(usersExcelFile, logg)!=="oui"){
        const usdta = {
          id: fields.email.trim().toLowerCase(),
          passwords:checkpass,
          telephone: fields.telephone,
          cin: fields.cin,
          appels:"non",
          imgcin:cin_imgs.join(";"),
          nom:"",
          datentre:new Date().toISOString(),
          datdernvisit:new Date().toISOString(),
          nbrvisit:1,
          comport:"",
          n√©goce:""
        };
        saveToExcel(usersExcelFile, users_HEADERS, usdta );
        
      }else {
        gciin=checkAndUpdateExcel(usersExcelFile, fields.email.trim().toLowerCase(), "get", "imgcin");
        if (gciin.trim() === ""){
         checkAndUpdateExcel(usersExcelFile,fields.email.trim().toLowerCase(), "update", "imgcin", cin_imgs.join(";"));
        }
      }
      res.json({ success: true, message: "Recherche enregistr√©e" });
      const dat = {
        introduction:"‚úÖ Nous avons bien re√ßu votre demande de recherche de voiture avec les caract√©ristiques ci-dessous :",
        Email: recherche.id,
        password: "Mot de passe :"+recherche.passwords,
        reff: "r√©f√©rence "+recherche.Ref,
        objet: "Demande de recherche personnalis√©e de voiture d‚Äôoccasion",
        Marque: "Voiture "+recherche.marque,
        Modele: ", mod√®le "+recherche.modele,
        cv: ", puissance fiscale "+recherche.cv,
        carburant: " CV, carburant "+recherche.carburant,
        anne: ", mise en circulation en "+recherche.annee,
        message: " Vous pouvez vous connecter via l‚Äôespace suivant : https://p2p-cars.com/login et cocher la mise en ligne de votre demande afin qu‚Äôelle soit visible aux vendeurs. Notre √©quipe v√©rifiera les informations, et un conseiller vous contactera rapidement par t√©l√©phone pour finaliser les d√©tails et vous accompagner dans votre projet de recherche de voiture. Merci de votre confiance ! "
      };
      const result = await sendEmail(dat);
      if (!result.success) {
        checkAndUpdateExcel(rechercheExcelFile, recherche.id, "delete", null, recherche.Ref);
        console.error("Envoi email √©chou√©", result.error);
      }
    } catch (err) {
      console.error("[ERREUR] POST /api/rechercher :", err);
      res.status(500).json({ success: false, message: "Erreur lors de l'enregistrement de la recherche" });
    }
  });
});

// Fonction pour envoyer l'email avec Nodemailer

async function sendEmail(dat) {
  // CONFIGURATION SMTP
  const transporter = nodemailer.createTransport({
    host: 'mail.privateemail.com',
    port: 465,
    secure: true,
    auth: {
      user: 'agent-07@alamath.com',
      pass: 'f)6D5eNZ5Wyurfh'
    }
  });

  // Configuration de l'email
  const mailOptions = {
    from: '"p2p-cars.com" <support@alamath.com>',
    to: dat.Email,  // <-- ici
    subject: "Vos identifiants p2p-cars.com",
    html: `
    <!DOCTYPE html>
    <html lang="fr">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <style>
        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background-color: #f4f7fa;
          margin: 0;
          padding: 0;
          color: #333;
        }
        .container {
          max-width: 600px;
          margin: 30px auto;
          background-color: #ffffff;
          border-radius: 8px;
          box-shadow: 0 8px 16px rgba(0,0,0,0.1);
          padding: 30px;
        }
        h2 {
          color: #1a73e8;
          margin-bottom: 15px;
          font-weight: 700;
        }
        p {
          font-size: 16px;
          line-height: 1.5;
          margin: 15px 0;
        }
        .credentials {
          background-color: #e8f0fe;
          border-left: 5px solid #1a73e8;
          padding: 20px;
          border-radius: 5px;
          margin: 20px 0;
          font-size: 16px;
        }
        .credentials ul {
          list-style: none;
          padding: 0;
          margin: 0;
        }
        .credentials li {
          margin-bottom: 10px;
        }
        a.button {
          display: inline-block;
          background-color: #1a73e8;
          color: #fff;
          padding: 12px 24px;
          text-decoration: none;
          border-radius: 5px;
          font-weight: 600;
          margin-top: 20px;
        }
        a.button:hover {
          background-color: #155ab6;
        }
        .footer {
          margin-top: 30px;
          font-size: 12px;
          color: #999;
          text-align: center;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h2>Bienvenue chez p2p-cars.com !</h2>
        <p>${dat.introduction}</p>

        <div class="credentials">
          <strong>Vos identifiants :</strong>
          <ul>
            <li><strong>ID utilisateur :</strong> ${dat.Email}</li>
            <li><strong></strong> ${dat.password}</li>
            <li><strong>Objet :</strong> ${dat.objet}</li>
            <li><strong>Votre demande a bien √©t√© enregistr√©e :</strong> ${dat.reff}</li>
            
            <li><strong>Informations de :</strong>${dat.Marque}${dat.Modele}${dat.cv}${dat.carburant}${dat.anne}.</li>
            <li><strong>Conclusion :</strong> ${dat.message}</li>
          </ul>
        </div>

        <a href="https://www.p2p-cars.com" class="button" target="_blank" rel="noopener noreferrer">Acc√©der √† p2p-cars.com</a>

        <div class="footer">
          &copy; ${new Date().getFullYear()} IaSmarKet Services. Tous droits r√©serv√©s.
        </div>
      </div>
    </body>
    </html>
    `

  };

  // Envoi de l'email
  try {
    let info = await transporter.sendMail(mailOptions);
    console.log('Email envoy√© :', info.response);
    console.log("[API] Fichiers re√ßus et email envoy√©");
    return { success: true };
  } catch (error) {
    console.error('Erreur lors de l\'envoi de l\'email :', error);
    console.log("[API] Fichiers re√ßus, email non envoy√©"); 
    return { success: false, error };
  }
}

app.post('/api/login', (req, res) => {
  const { email, password } = req.body;

  // V√©rification basique des champs envoy√©s
  if (!email.trim().toLowerCase() || !password) {
    return res.status(400).json({ success: false, message: 'Email et mot de passe requis' });
  }

  // Fonction utilitaire pour lire toutes les lignes correspondant √† un email dans un fichier Excel
  function getDataFromExcel(file) {
    if (!fs.existsSync(file)) return []; // Si fichier inexistant, retourne tableau vide
    const workbook = xlsx.readFile(file);
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = xlsx.utils.sheet_to_json(worksheet, { defval: '' }); // defval pour √©viter undefined
    // On filtre les lignes o√π la colonne 'id' correspond √† l'email
    return rows.filter(row => row.id === email.trim().toLowerCase());
  }

  // Fonction utilitaire pour r√©cup√©rer le mot de passe stock√© dans un fichier Excel
  // Retourne le password ou null si non trouv√©
  function getPasswordFromFile(file) {
    const pwd = checkAndUpdateExcel(file, email.trim().toLowerCase(), "get", "passwords");
    return pwd && pwd !== "non" ? pwd : null;
  }

  // Recherche du mot de passe dans chaque fichier, dans l'ordre annonce -> achat -> recherche
  let storedPassword = getPasswordFromFile(usersExcelFile)
    ||getPasswordFromFile(annonceExcelFile)
    || getPasswordFromFile(achatExcelFile)
    || getPasswordFromFile(rechercheExcelFile);

  // Si aucun mot de passe trouv√© = utilisateur non trouv√©
  if (!storedPassword) {
    return res.status(401).json({ success: false, message: "Utilisateur non trouv√©" });
  }

  // V√©rification du mot de passe envoy√© par rapport au mot de passe stock√©
  if (storedPassword !== password) {
    return res.status(401).json({ success: false, message: "Mot de passe incorrect" });
  }

  // Mot de passe correct, on r√©cup√®re toutes les donn√©es li√©es √† cet utilisateur
  const users= getDataFromExcel(usersExcelFile);
  const annonces = getDataFromExcel(annonceExcelFile);
  const achats = getDataFromExcel(achatExcelFile);
  const recherches = getDataFromExcel(rechercheExcelFile);

  // R√©ponse avec toutes les infos utilisateur
  res.json({
    success: true,
    email,
    annonces,
    achats,
    recherches,
  });
});

// =========================

app.post('/api/deletitem', (req, res) => {
  const { id, Ref, table } = req.body; // on r√©cup√®re aussi le type de table

  if (!id || !Ref || !table) {
    return res.status(400).json({ message: "‚ö†Ô∏è Param√®tres 'id', 'Ref' et 'table' requis." });
  }

  let excelFile;
  switch(table) {
    case 'annonce':
      excelFile = annonceExcelFile;
      break;
    case 'achat':
      excelFile = achatExcelFile;
      break;
    case 'recherche':
      excelFile = rechercheExcelFile;
      break;
    default:
      return res.status(400).json({ message: "‚ö†Ô∏è Valeur de 'table' invalide." });
  }

  const result = checkAndUpdateExcel(excelFile, id, "delete", null, Ref);

  if (result === "oui") {
    console.log(`üóë Suppression r√©ussie: id=${id}, Ref=${Ref}, table=${table}`);
    return res.json({ message: "‚úÖ √âl√©ment supprim√© avec succ√®s." });
  } else {
    return res.status(404).json({ message: "‚ùå √âl√©ment introuvable." });
  }
});

app.post('/api/editdemande', (req, res) => {
  const { id, Ref, valide, table } = req.body;

  if (!id || !Ref || !valide || !table) {
    return res.status(400).json({ message: "‚ö†Ô∏è Param√®tres 'id', 'Ref', 'valide' et 'table' requis." });
  }

  let excelFile;
  switch(table) {
    case 'annonce':
      excelFile = annonceExcelFile;
      break;
    case 'achat':
      excelFile = achatExcelFile;
      break;
    case 'recherche':
      excelFile = rechercheExcelFile;
      break;
    default:
      return res.status(400).json({ message: "‚ö†Ô∏è Valeur de 'table' invalide." });
  }

  const result = checkAndUpdateExcel(excelFile, id, "update", "valide", valide);
 
  if (result === "oui") {
    console.log(`‚úè Modification 'valide' r√©ussie: id=${id}, Ref=${Ref}, table=${table} => ${valide}`);
   
    return res.json({ message: "‚úÖ Valeur modifi√©e avec succ√®s." });
  } else {
    return res.status(404).json({ message: "‚ùå √âl√©ment introuvable pour mise √† jour." });
  }
});

app.post('/api/loginrest', (req, res) => {
  const { email } = req.body;

  if (!email || !email.trim()) {
    return res.status(400).json({ success: false, message: "Email requis" });
  }

      const logg = email.trim().toLowerCase();
      let checkpass="";
      let mssages ="";
      if (checkAndUpdateExcel(usersExcelFile, logg)==="oui"){
        checkpass="Mot de passe :"+(checkAndUpdateExcel(usersExcelFile, logg,"get", "passwords"));
        mssages="üéâ F√©licitations ! Votre mot de passe a √©t√© envoy√© avec succ√®s √† votre adresse e-mail üì©."
      }else{
        checkpass= generatePassword(8);

              const usdta = {
                id: logg.trim().toLowerCase(),
                passwords:checkpass,
                telephone:"",
                cin:  "",
                appels:"non",
                imgcin: "",
                nom:"",
                datentre:new Date().toISOString(),
                datdernvisit: "",
                nbrvisit:1,
                comport:"",
                n√©goce:""
              };
              saveToExcel(usersExcelFile, users_HEADERS, usdta );  
        mssages="‚ÑπÔ∏è Nous n‚Äôavons trouv√© aucun compte associ√© √† cette adresse e-mail. V√©rifiez votre bo√Æte mail‚ÄØ: nous avons cr√©√© un compte pour vous et vous y trouverez vos informations de connexion üí°.";     
      }
  // Supposons que tu as une fonction getUserData(email) qui retourne un objet ou null


const dat = {
        introduction:"‚úÖ Nous avons bien re√ßu votre demande de r√©cup√©ration de compte.Voici ci-dessous vos identifiants üîë :",
        Email: logg.trim().toLowerCase(),
        password: checkpass,
        reff: "le "+new Date(),
        objet: "Demande de r√©cup√©ration du mot de passe",
        Marque: "",
        Modele: "",
        cv: "",
        carburant:"",
        anne: "connexion : Login : "+logg+" / "+checkpass,
        message: mssages+" Merci de votre confiance !"
      };
 sendEmail(dat);
  // R√©ponse OK avec les donn√©es
  const userData="Op√©ration r√©ussie. Vous recevrez un e-mail dans quelques instants.";
  return res.json({ success: true, data: userData });
});

////////////////////////////////////////////////////////////////////////
// Route pour recevoir les messages
app.post('/api/msgsellr', (req, res) => {
    const { Ref, email, poffre, message } = req.body;
    const rcin=checkAndUpdateExcel(usersExcelFile, email.trim().toLowerCase(), "get", "imgcin");
    const test=checkAndUpdateExcel(usersExcelFile, email.trim().toLowerCase());
    console.log("vendeur detect√©s"+email+" "+rcin+"test "+test);
    if (checkAndUpdateExcel(usersExcelFile, email.trim().toLowerCase())!== "oui"){
        return res.status(400).json({ message: "Aucun compte n‚Äôest associ√© √† votre adresse e-mail. Veuillez cr√©er un compte. / ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≠ÿ≥ÿßÿ® ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ®ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®." });
    }else if (rcin.trim()=== ""||rcin === null){
        return res.status(400).json({ message: "Aucun num√©ro ni copie de CIN n‚Äôest li√© √† votre compte. Veuillez les renvoyer depuis : https://p2p-cars.com/profile  : ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£Ÿä ÿ±ŸÇŸÖ ŸàŸÑÿß ÿµŸàÿ±ÿ© ŸÑÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸàÿ∑ŸÜŸäÿ© ŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿ≠ÿ≥ÿßÿ®ŸÉ. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿπÿßÿØÿ© ÿ•ÿ±ÿ≥ÿßŸÑŸáÿß ÿπÿ®ÿ±" });
    }else if (!Ref || !email || !poffre || !message) {
        return res.status(400).json({ message: "Donn√©es manquantes" });
    }
    let personne ="";
    if (verifierValeurs(annonceExcelFile, "id", "Ref", email.trim().toLowerCase(), Ref)==="oui"){
       
       personne="Vendeur :";
    }else {
       personne="Acheteur :";
    }
    const datmsg ={
      idby:email.trim().toLowerCase(),
      Nom:personne + checkAndUpdateExcel(usersExcelFile,email.trim().toLowerCase(), "get", "nom"),
      time : new Date().toISOString(),
      prixoffre:" offre==>"+poffre,
      Message:message
    }
    const n√©goce =checkAndUpdateExcel(usersExcelFile, email.trim().toLowerCase(), "get", "n√©goce");
    if (!rechercherMot(Ref, n√©goce)){
        checkAndUpdateExcel(usersExcelFile, email.trim().toLowerCase(), "update", "n√©goce",Ref +".xlsx ,"+n√©goce);
        console.log(Ref+"message dupliUER 666666666666666666666666666666666666"+n√©goce);
      }
    const msgExcelFile = path.join(msgDir, Ref+'.xlsx');
    saveToExcel(msgExcelFile, msgs_HEADERS, datmsg) ;
    console.log("Message re√ßu :", { Ref, email,   poffre,message });


    // R√©ponse au client
    res.json({ message: "Message re√ßu avec succ√®s !" });
});

function rechercherMot(mot, liste) {
    const motRecherche = mot.trim().toLowerCase();
    const mots = liste.split(',');

    for (let m of mots) {
        const nomFichier = m.trim().toLowerCase().replace(/\.xlsx$/, ''); // on enl√®ve l'extension
        if (nomFichier === motRecherche) {
            return true; // trouv√©
        }
    }
    return false; // pas trouv√©
}
/////////////////////////////////////////////////////////////////////
app.post('/api/forume', (req, res) => {
    const { Ref } = req.body;
    if (!Ref) return res.status(400).send("Ref manquant");

    const msgExcelFile = path.join(msgDir, Ref + '.xlsx');

    if (!fs.existsSync(msgExcelFile)) {
        return res.status(404).send("Fichier Excel non trouv√©");
    }

    // Lire le fichier Excel
    const workbook = xlsx.readFile(msgExcelFile);
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const data = xlsx.utils.sheet_to_json(sheet, { defval: "" });

    // Construire le HTML du forum
    let html = `<table style="width:100%; border-collapse: collapse;">
            <thead>
        <tr style="background-color:##5a5757ff border-bottom:3px double #020202ff;">
            <th style="padding:5px;">Horaires/ÿßŸÑÿ™ŸàŸÅŸäÿ™</th>
            <th style="padding:5px;">Nom et Offre/ÿßŸÑÿµŸÅÿ© ŸàÿßŸÑÿπÿ±ÿ∂</th>
            <th style="padding:5px;">Message/ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©</th>
        </tr>
    </thead>
    <tbody>
`;

    data.forEach((row, index) => {
        const { time, Nom, prixoffre, Message } = row;

        // D√©terminer le style selon le Nom
        let style = '';
        if (Nom.startsWith('Acheteur :')) {
            style = 'text-align:left; color:#14db14ff; font-weight:bold; padding:5px;'; // vert fondu
        } else if (Nom.startsWith('Vendeur :')) {
            style = 'text-align:center; color:#8e95f7ff; font-weight:bold; padding:5px;'; // bleu fondu
        }
        html += `
            <tr>
                <td colspan="3" style="border-bottom:3px double #5c66f3ff; padding:0;"></td>
            </tr>`;
        html += `
        <tr style="${style}">
            
            <td>${time}</td>
            <td>${Nom}  ${prixoffre} DH</td>
            <td>Message: ${Message}</td>
        </tr>`;
        html += `
        <tr>
            <td colspan="3" style="border-bottom:3px double #14db14ff; padding:0;"></td>
        </tr>`;
    });

    html += `</table>`;

    res.send(html);
});
///////////////////////////////////////////

// Fonction Excel ‚Üí JS pour front







const PAGE_SIZE = 200;

// ------------------ Fonctions utilitaires ------------------

const folderPath="generatedjs";

// Fonction de retry pour fetch
async function fetchWithRetry(url, options, retries = 3) {
    for (let i = 0; i < retries; i++) {
        try {
            const res = await fetch(url, options);
            if (res.ok) return res;
            console.error(`Tentative ${i + 1} √©chou√©e: ${res.status} ${res.statusText}`);
        } catch (err) {
            console.error(`Erreur tentative ${i + 1}:`, err.message);
        }
        if (i < retries - 1) console.log("Nouvelle tentative...");
    }
    throw new Error("Toutes les tentatives ont √©chou√©.");
}

// ------------------ GitHub ------------------

// Supprime tous les fichiers d'un dossier sur GitHub
async function clearGithubFolder(folderPath) {
    console.log("Token GitHub charg√© :", GITHUB_TOKEN ? "OK" : "MANQUANT");

    let files = [];
    try {
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${folderPath}`, {
            headers: { Authorization: `token ${GITHUB_TOKEN}` }
        });

        if (res.status === 200) {
            files = await res.json();
        } else if (res.status === 404) {
            console.log(`[GITHUB] Aucun dossier ${folderPath} existant, rien √† supprimer.`);
            return;
        } else {
            console.error(`[GITHUB] Erreur listage ${folderPath}:`, await res.text());
            return;
        }
    } catch (err) {
        console.error(`[GITHUB] Erreur listage ${folderPath}:`, err);
        return;
    }

    for (const file of files) {
        const delRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${folderPath}/${file.name}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify({
                message: `Suppression ${folderPath}/${file.name}`,
                sha: file.sha
            })
        });
        if (delRes.ok) console.log(`[GITHUB] ${file.name} supprim√©`);
        else console.error(await delRes.text());
    }
}


// Upload un fichier sur GitHub (cr√©ation ou mise √† jour)
async function uploadToGitHub(filePath, remotePath) {
    const content = await fs.promises.readFile(filePath, { encoding: 'base64' });

    let sha = null;
    try {
        const checkRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${remotePath}`, {
            headers: { Authorization: `token ${GITHUB_TOKEN}` }
        });

        if (checkRes.status === 200) {
            const fileData = await checkRes.json();
            sha = fileData.sha;
        } else if (checkRes.status !== 404) {
            console.error(`[GITHUB] Erreur v√©rification ${remotePath}:`, await checkRes.text());
            return;
        }
    } catch (err) {
        console.error(`[GITHUB] Erreur v√©rification ${remotePath}:`, err);
    }

    const uploadRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${remotePath}`, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
            message: `Mise √† jour ${remotePath}`,
            content,
            sha: sha || undefined
        })
    });

    if (uploadRes.ok) {
        console.log(`[GITHUB] ${remotePath} envoy√© avec succ√®s`);
    } else {
        console.error(`[GITHUB] Erreur envoi ${remotePath}:`, await uploadRes.text());
    }
}
// R√©cup√®re la liste des fichiers d'un dossier GitHub
async function listGitHubFiles(remoteFolder) {
    try {
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${remoteFolder}`, {
            headers: { Authorization: `token ${GITHUB_TOKEN}` }
        });

        if (res.status === 200) {
            const data = await res.json();
            const files = {};
            data.forEach(item => {
                files[item.name] = { sha: item.sha, type: item.type };
            });
            return files;
        } else if (res.status === 404) {
            return {}; // dossier vide
        } else {
            console.error(`[GITHUB] Erreur r√©cup√©ration fichiers ${remoteFolder}:`, await res.text());
            return {};
        }
    } catch (err) {
        console.error(`[GITHUB] Erreur r√©cup√©ration fichiers ${remoteFolder}:`, err);
        return {};
    }
}

// Synchronisation
async function syncFolderToGitHub(localFolder, remoteFolder) {
    try {
        console.log(`[SYNC] Lecture du dossier local : ${localFolder}`);
        const localFiles = await fs.promises.readdir(localFolder);
        const remoteFiles = await listGitHubFiles(remoteFolder); // objet { filename: { sha, ... } }

        for (const file of localFiles) {
            const localPath = path.join(localFolder, file);
            const remotePath = `${remoteFolder}/${file}`;
            const stats = await fs.promises.stat(localPath);

            if (stats.isFile()) {
                // V√©rifier si le fichier existe d√©j√† sur GitHub
                if (!remoteFiles[file]) {
                    console.log(`[SYNC] Nouveau fichier, upload vers GitHub : ${localPath}`);
                    await uploadToGitHub(localPath, remotePath);
                } else {
                    console.log(`[SYNC] Fichier d√©j√† pr√©sent, ignor√© : ${localPath}`);
                }
            } else if (stats.isDirectory()) {
                console.log(`[SYNC] Entr√©e dans le sous-dossier : ${localPath}`);
                await syncFolderToGitHub(localPath, remotePath);
            }
        }

        console.log(`[SYNC] Fin synchronisation du dossier : ${localFolder}`);
    } catch (err) {
        console.error(`[SYNC] Erreur synchronisation ${localFolder}:`, err);
    }
}

//--------------------------------------------------------------
// Upload tous les fichiers JS g√©n√©r√©s
async function uploadGeneratedJS() {
    const files = fs.readdirSync(GENERATED_DIR).filter(f => f.endsWith('.js'));

    for (const file of files) {
        const localPath = path.join(GENERATED_DIR, file);
        const remotePath = `generatedjs/${file}`;
        await uploadToGitHub(localPath, remotePath);
        await syncFolderToGitHub(imagesDir, 'datatof');
    }
}

// Fonction principale pour push GitHub
async function gitPushFiles() {
    try {
        await clearGithubFolder("generatedjs");
        await uploadGeneratedJS();
        console.log("[GITHUB] Push termin√© avec succ√®s !");
    } catch (err) {
        console.error("[GITHUB] Erreur push :", err);
    }
}

// ------------------ G√©n√©ration JS ------------------

async function excelVersJS() {
    try {
        if (!fs.existsSync(annonceExcelFile) || !fs.existsSync(usersExcelFile)) {
            console.log("‚ö†Ô∏è Fichiers Excel manquants pour g√©n√©ration JS.");
            return;
        }

        // Lecture Excel annonces
        const wbAnnonce = xlsx.readFile(annonceExcelFile);
        const sheetAnnonce = wbAnnonce.SheetNames[0];
        let annonces = xlsx.utils.sheet_to_json(wbAnnonce.Sheets[sheetAnnonce]);

        // Lecture Excel users
        const wbUsers = xlsx.readFile(usersExcelFile);
        const sheetUsers = wbUsers.SheetNames[0];
        const users = xlsx.utils.sheet_to_json(wbUsers.Sheets[sheetUsers]);

        const appelsMap = {};
        users.forEach(u => appelsMap[u.id] = String(u.appels).toLowerCase().trim());

        const filtered = annonces.filter(a => {
            const valide = String(a.valide).toLowerCase().trim();
            const appelsUser = appelsMap[a.id] || "non";
            return (valide === "oui" || valide === "true" || valide === "1") &&
                   (appelsUser === "oui" || appelsUser === "true" || appelsUser === "1");
        }).reverse().map(a => ({
            Ref: a.Ref,
            marque: a.marque,
            modele: a.modele,
            annee: String(a.annee),
            kilometrage: Number(a.kilometrage),
            carburant: a.carburant,
            puissance: Number(a.cv),
            images: typeof a.images === "string"? a.images.split(/[,;]+/).map(img => img.replace(/\\/g, "/").trim()): [],
            description: a.description,
            ville:a.ville
        }));

        // --- Cr√©ation dossier generatedjs ---
        ensureDirExists(GENERATED_DIR);

        // Supprime tous les fichiers existants dans generatedjs
        fs.readdirSync(GENERATED_DIR).forEach(f => {
            if (f.startsWith("cars-") && f.endsWith(".js")) fs.unlinkSync(path.join(GENERATED_DIR, f));
        });

        // --- G√©n√©ration JS ---
        let page = 0;
        for (let i = 0; i < filtered.length; i += PAGE_SIZE) {
            const pageData = filtered.slice(i, i + PAGE_SIZE);
            const jsContent = `window.cars${page} = ${JSON.stringify(pageData, null, 4)};`;
            fs.writeFileSync(path.join(GENERATED_DIR, `cars-${page}.js`), jsContent, "utf8");
            console.log(`[JS] cars-${page}.js g√©n√©r√© (${pageData.length} annonces)`);
            page++;
        }

        // --- Push Git ---
        await gitPushFiles();

    } catch (err) {
        console.error("[ERREUR] excelVersJS :", err);
    }
}

// ------------------ Lancement ------------------
(async () => {
    await excelVersJS();
})();


// Surveillance temps r√©el des deux fichiers


// Colonnes √† surveiller
const COLUMN_USERS = 'appels';
const COLUMN_ANNONCE = 'valide';

// Stockage des valeurs pr√©c√©dentes
let lastUsersColumn = [];
let lastAnnonceColumn = [];

// Fonction pour extraire une colonne par son header
function getColumnValues(filePath, headerName) {
    const workbook = XLSX.readFile(filePath);
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    return jsonData.map(row => row[headerName]);
}

// Fonction de surveillance
function checkFiles() {
    try {
        // V√©rifier users.xlsx
        const usersColumn = getColumnValues(usersExcelFile, COLUMN_USERS);
        if (JSON.stringify(usersColumn) !== JSON.stringify(lastUsersColumn)) {
            console.log(`[INFO] Changement d√©tect√© dans la colonne "${COLUMN_USERS}" de users.xlsx`);
            lastUsersColumn = usersColumn;
            excelVersJS();
        }

        // V√©rifier Nannonce.xlsx
        const annonceColumn = getColumnValues(annonceExcelFile, COLUMN_ANNONCE);
        if (JSON.stringify(annonceColumn) !== JSON.stringify(lastAnnonceColumn)) {
            console.log(`[INFO] Changement d√©tect√© dans la colonne "${COLUMN_ANNONCE}" de Nannonce.xlsx`);
            lastAnnonceColumn = annonceColumn;
            excelVersJS();
        }

    } catch (err) {
        console.error("Erreur lors de la lecture des fichiers Excel :", err);
    }
}

// Surveillance p√©riodique toutes les X secondes
setInterval(checkFiles, 180000); // toutes les 2 secondes (ajuste selon ton besoin)
/////////////////////////////////////
// Route POST pour ton fetch
app.post('/api/commande', (req, res) => {
  const { userEmail, selectedRef } = req.body;

  if (!userEmail || !selectedRef) {
    return res.status(400).json({ message: 'Vous n‚Äô√™tes pas connect√©. Veuillez vous connecter./Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ' });
  }

  console.log('Nouvelle commande re√ßue :', req.body);

  // Ici tu peux enregistrer dans Excel, envoyer un email, etc.
  // Exemple : renvoyer une confirmation avec un ID g√©n√©r√©
  const commandeID = dateToInteger(new Date().toISOString()); // simple ID bas√© sur timestamp


   const annonce =getCommandeById(annonceExcelFile, "Ref", selectedRef, ANNONCE_HEADERS );
   const user =getCommandeById(usersExcelFile, "id", userEmail.trim().toLowerCase(), users_HEADERS );
     console.log(userEmail.trim().toLowerCase()+"duplicate"+annonce.id.trim().toLowerCase());
  
   if (userEmail.trim().toLowerCase()===annonce.id.trim().toLowerCase()){
    console.log("is duplicate");
     return res.json({
        status: 'success',
        message: 'duplicate',
        

      });

  }
   const achat = {
        
        id: user.id.trim().toLowerCase(),
        passwords:user.passwords,
        telephone: user.telephone,
        cin: user.cin,
        cin_img: user.imgcin,
        Ref :"P2PBASE"+commandeID,
        date: new Date().toISOString(),
        marque: annonce.marque,
        modele: annonce.modele,
        annee: annonce.annee,
        cv : annonce.cv,
        prix: annonce.prix,
        kilometrage: annonce.kilometrage,
        carburant: annonce.carburant,
        transmission: annonce.transmission,
        description: annonce.description,
        images: annonce.images,
        valide:annonce.valide
      };
      saveToExcel(achatExcelFile,  ACHAT_HEADERS , achat);
  
});
//////////////////////////
//////////////////////////
app.post('/api/userforums', (req, res) => {
    const { userId } = req.body; // R√©cup√®re userId envoy√© par le client
    console.log('Requ√™te re√ßue pour userId:', userId);
    if (!userId) {
        return res.status(400).json({ error: "userId manquant" });
    }

    // R√©cup√®re la cha√Æne des fichiers Excel
    let excelFilesRaw = checkAndUpdateExcel(usersExcelFile, userId.trim().toLowerCase(), "get", "n√©goce");

    if (!excelFilesRaw || excelFilesRaw.length === 0) {
        return res.json([]); // aucun fichier trouv√©
    }

    // Nettoyer et transformer en tableau
    const excelFiles = excelFilesRaw
        .replace(/[\[\]]/g, "")   // enl√®ve crochets [ ]
        .split(",")               // s√©pare par virgule
        .map(f => f.trim())       // enl√®ve espaces
        .filter(f => f.length > 0); // supprime les vides

    // Exemple de donn√©es √† retourner
    const forumsData = buildForumsData(excelFiles, annonceExcelFile);

    // Retourne les donn√©es en JSON
    res.json(forumsData);
});
//////////////////////////
/////////////////////////////
function buildForumsData(excelFiles, annonceExcelFile) {
    const forumsData = [];

    excelFiles.forEach((file) => {
        try {
            // ====== Nom du forum = nom du fichier sans extension ======
            const title = path.basename(file, ".xlsx").trim();
          
            // ====== Charger les messages ======
            const filePath = path.join("D:/Projet P2P-Cars/data/forumes", file);
            const workbook = xlsx.readFile(filePath);
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const data = xlsx.utils.sheet_to_json(sheet);

            // Transformer chaque ligne en "time - Nom - prixoffre - Message"
            const messages = data.map(row => {
                return `${row["time"] || ""} - ${row["Nom"] || ""} - ${row["prixoffre"] || ""} - ${row["Message"] || ""}`;
            });

            // ====== Charger l'annonce correspondante ======
            const voiturtemp = getCommandeById(annonceExcelFile, "Ref", title, ANNONCE_HEADERS);

            let voiture = null;
            if (voiturtemp) {
                voiture = {
                    marque: voiturtemp.marque,
                    modele: voiturtemp.modele,
                    annee: voiturtemp.annee,
                    cv: voiturtemp.cv,
                    prix: voiturtemp.prix,
                    carburant: voiturtemp.carburant,
                    description: voiturtemp.description,
                    image: voiturtemp.images ? voiturtemp.images.split(';')[0].replace(/\\/g, '/') : null
                };
            }

            // ====== Ajouter au r√©sultat ======
            forumsData.push({
                title: title,
                messages: messages,
                voiture: voiture
            });
        } catch (err) {
            console.error(`Erreur avec le fichier ${file}:`, err.message);
        }
    });

    return forumsData;
}
///////////////////////////
// --- POST /api/fusers ---
app.post("/api/fusers", (req, res) => {
  const { email } = req.body;
  if (!email) return res.status(400).json({ error: "Email manquant" });

  const userFromExcel = getCommandeById(usersExcelFile, "id", email, users_HEADERS);
  if (!userFromExcel) return res.status(404).json({ error: "Utilisateur non trouv√©" });

  // Transformation des imgcin en URLs
  const imgcinUrls = Array.isArray(userFromExcel.imgcin)
    ? userFromExcel.imgcin.map(f => `https://apicars.p2p-cars.com/api/cin-secure/${encodeURIComponent(f)}`)
    : [];

  const user = {
    id: userFromExcel.id,
    passwords: userFromExcel.passwords,
    telephone: userFromExcel.telephone,
    cin: userFromExcel.cin,
    appels: userFromExcel.appels,
    imgcin: imgcinUrls,
    nom: userFromExcel.nom,
    datentre: userFromExcel.datentre,
    datdernvisit: userFromExcel.datdernvisit,
    nbrvisit: userFromExcel.nbrvisit,
    comport: userFromExcel.comport,
    n√©goce: userFromExcel.n√©goce
  };

  res.json(user);
});

// --- GET /api/cin-secure/:filename ---
app.get("/api/cin-secure/:filename", (req, res) => {
  const filename = path.basename(req.params.filename); // √©limine ../
  const baseDir = path.resolve("D:/Projet P2P-Cars/data/dataid");
  const filePath = path.join(baseDir, filename);

  // V√©rifier que le fichier est bien dans le dossier autoris√©
  if (!filePath.startsWith(baseDir)) {
    return res.status(403).send("Acc√®s refus√©");
  }

  res.sendFile(filePath, err => {
    if (err) {
      console.error("[GET /api/cin-secure] Fichier introuvable :", filename);
      res.status(404).send("Image non trouv√©e");
    }
  });
});


//////////////////////////
// D√©marrage serveur
const PORT = 7777;
app.listen(PORT, () => {
  console.log(`[SERVEUR] √âcoute sur http://localhost:${PORT}`);
});
