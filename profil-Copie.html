<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P-CARS - Profil</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --blue: #3b82f6;
      --blue-dark: #2563eb;
      --bg-input: #1e293b;
      --text: #e2e8f0;
      --muted: rgba(226,232,240,0.85);
      --error: #ff6b6b;
      --success: #34d399;
    }
    body {
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.301), rgba(30, 41, 59, 0.247)),
                  url('arier.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 20px;
    }
    header {
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 14px 10px 20px 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      gap: 40px;
    }
    header img { max-height: 110px; width: auto; object-fit: contain; transition: transform 0.3s; }
    header img:hover { transform: scale(1.05);}
    header .header-center { display: flex; flex-direction: column; align-items: center; text-align: center;}
    header h1 { font-size: 2.4rem; font-weight: 700; color: var(--blue); margin-bottom: 0.3em;}
    header .text-h { font-size: 1.1rem; color: var(--text); letter-spacing: 0.5px;}
    @media (max-width: 750px) {
      header { flex-direction: column; gap: 12px;}
      header img { max-width: 70%; }
      header h1 { font-size: 2rem;}
    }
    .navbar { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; margin-top: 1rem; }
    .lang-btns { display: flex; gap: 0.5rem; align-items: center; }
    .lang-btns button { width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--blue); background: var(--bg-input); color: var(--blue);
      font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s; font-size: 1rem; }
    .lang-btns button.active, .lang-btns button:hover { background: var(--blue); color: #fff; }
    .home-btn { margin-left: 0.7rem; background: #fff; color: #1e293b; border-radius: 20px; padding: 8px 16px; border: none; font-weight: 600;
      font-size: 1rem; text-decoration: none; box-shadow: 0 2px 4px rgba(0,0,0,0.07); transition: background 0.2s, color 0.2s; }
    .home-btn:hover { background: var(--blue); color: #fff; }
    h1 { color: var(--blue); }
    /* Table container for mobile scroll */
    .table-container { width: 100%; overflow-x: auto; }
    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:0.92rem; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; min-width:600px;}
    th, td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
    th { background: rgba(59,130,246,0.12); color:#fff; font-weight:600; }
    tr:hover { background: rgba(59,130,246,0.06); }
    .icon-btn { cursor:pointer; color:#ff6b6b; font-size:1rem; }
    .icon-btn:hover { color:#ff0000; }
    footer { background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; text-align: center; color: #94a3b8; font-size: 0.9rem; margin-top: auto; box-shadow: 0 -2px 10px rgba(0,0,0,0.25);}
    /* Responsive mobile: affichage vertical, scroll horizontal tableau, texte réduit */
    @media (max-width: 600px) {
      body { padding: 4px;}
      h1 { font-size: 1.18rem;}
      .navbar { flex-direction: column; gap: 0.5rem;}
      .home-btn { margin-left: 0;}
      .table-container { padding-bottom: 12px; }
      table { font-size: 0.74rem; min-width: 500px;}
      th, td { padding: 4px 6px;}
      .icon-btn { font-size: 0.93rem;}
    }
    @media (max-width: 420px) {
      th, td { padding: 2px 2px;}
      table { font-size: 0.67rem; min-width: 400px;}
    }
    /* Conteneur du menu centré */
  .navbar {
    display: flex;
    justify-content: center;  /* Centre horizontalement */
    align-items: center;
    gap: 1rem;
    margin: 20px 0;
    flex-wrap: wrap; /* permet de passer en ligne suivante sur mobile */
  }

  /* Boutons principaux du menu */
  .menu-btn {
    background: var(--blue);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 12px 26px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .menu-btn:hover {
    background: var(--blue-dark);
    transform: translateY(-2px);
  }

  /* Bouton Accueil spécial avec icône */
  .home-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--blue);
    color: #fff !important;
    border-radius: 25px;
    padding: 12px 24px;
    font-size: 1.1rem;
    font-weight: 600;
    text-decoration: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .home-btn:hover {
    background: var(--blue-dark);
    transform: translateY(-2px);
  }

  /* Boutons langues modernisés */
  .lang-btns {
    display: flex;
    gap: 0.7rem;
  }

  .lang-btns button {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: none;
    background: var(--bg-input);
    color: var(--blue);
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    transition: all 0.3s ease;
  }

  .lang-btns button.active,
  .lang-btns button:hover {
    background: var(--blue);
    color: #fff;
    transform: scale(1.1);
  }
  /* Conteneur des onglets centré */
  .tablist {
    display: flex;
    justify-content: center;  /* Centre horizontalement */
    align-items: center;
    gap: 1rem;
    margin: 25px 0;
    flex-wrap: wrap; /* Passe en ligne suivante si petit écran */
  }

  /* Style des onglets */
  .tablist button[role="tab"] {
    background: var(--bg-input);
    color: var(--text);
    border: none;
    border-radius: 25px;
    padding: 12px 28px;
    font-size: 1.05rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  /* Onglet actif (sélectionné) */
  .tablist button[role="tab"][aria-selected="true"] {
    background: var(--blue);
    color: #fff;
    transform: translateY(-2px);
  }

  /* Effet hover */
  .tablist button[role="tab"]:hover {
    background: var(--blue-dark);
    color: #fff;
    transform: translateY(-2px);
  }
.forum {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #ccc;
}

.forum-left {
    flex: 1;
    margin-right: 20px;
}

.forum-title {
    font-weight: bold;
    margin-bottom: 10px;
}

.forum-discussion {
    height: 150px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 5px;
    margin-bottom: 10px;
}

.forum-message {
    display: flex;
    gap: 5px;
}

.forum-message textarea {
    flex: 1;
    height: 50px;
}

.forum-right {
    width: 200px;
    border: 1px solid #aaa;
    padding: 10px;
    text-align: left;
}

.separator {
    border-bottom: 3px solid #000;
    margin: 20px 0;
}
  </style>
</head>
<body>
  <header>
    <img src="logo1.png" alt="Logo société mère">
    <div class="header-center">
      <h1>P2P-CARS</h1>
      <p class="text-h">Plateforme de Voitures d'Occasion</p>
    </div>
    <img src="logo4.png" alt="Logo plateforme">
  </header>

  <div class="navbar">
    <a href="/" class="home-btn"><i class="fas fa-home"></i> Accueil</a>
    <button id="logoutBtn" class="menu-btn">Déconnexion</button>
    <div class="lang-btns">
      <button id="lang-fr">FR</button>
      <button id="lang-en">EN</button>
      <button id="lang-ar">AR</button>
    </div>
  </div>

  <main>
    <h1 id="profile-title">Mon Espace Privé</h1>
    <p id= "clas" class="lead">Espace personnel pour gérer vos commandes, vos informations et vos négociations de prix.</p>
    
    <div>
      <span id="connected-label">Connecté en tant que :</span>
      <span id="emailDisplay"></span>
      <button id="logoutBtn" style="margin-left:20px;"></button>
    </div>
    <div id="message" style="margin-top: 10px;"></div>
    <div class="tabs" id="tabs-exemple">
      <div class="tablist" role="tablist" aria-label="Onglets principaux">
        <button role="tab" id="tab-demandes" aria-controls="panel-demandes" aria-selected="true"></button>
        <button role="tab" id="tab-negoce" aria-controls="panel-negoce" aria-selected="false" tabindex="-1"></button>
        <button role="tab" id="tab-infopers" aria-controls="panel-contact" aria-selected="false" tabindex="-1"></button>
        <button role="tab" id="tabcontactnous" aria-controls="panel-contactnous" aria-selected="false" tabindex="-1"></button>
      </div>


      <div class="panels">
        <section id="panel-demandes" role="tabpanel" aria-labelledby="tab-demandes">
          <section id="results" style="display:none; margin-top: 20px;" role="tabpanel" aria-labelledby="tab-demandes">
            <h2 id="title-annonces">Demandes de publication</h2>
            <div class="table-container"><table id="table-annonces"></table></div>
            <h2 id="title-achats">Demandes d'achats</h2>
            <div class="table-container"><table id="table-achats"></table></div>
            <h2 id="title-recherches">demandes de Recherches</h2>
            <div class="table-container"><table id="table-recherches"></table></div>
          </section>
        </section>

        <section id="panel-negoce" role="tabpanel" aria-labelledby="tab-negoce" hidden>

        </section>

        <section id="panel-contact" role="tabpanel" aria-labelledby="tab-infopers" hidden>

        </section>
        <section id="panel-contactnous" role="tabpanel" aria-labelledby="tabcontactnous" hidden>
          <style>
            #chat-wrapper {
              display:flex;
              flex-direction:column;
              height:80vh; /* Grande hauteur */
              border:1px solid #ccc;
              border-radius:10px;
              overflow:hidden;
              background:#fff;
            }

            #chat-container {
              flex:1;
              padding:15px;
              overflow-y:auto;
              background:#f9f9f9;
              display:flex;
              flex-direction:column;
            }

            .message {
              padding:10px 15px;
              margin:8px 0;
              border-radius:15px;
              max-width:70%;
              word-wrap:break-word;
              font-size:14px;
            }

            .user-message {
              background-color:#e0f0ff;
              color:#0044cc;
              align-self:flex-start;
            }

            .support-message {
              background-color:#d4ffd4;
              color:#008800;
              align-self:flex-end;
            }

            #chat-input {
              display:flex;
              border-top:1px solid #ccc;
              padding:10px;
              background:#fff;
            }

            #chat-input textarea {
              flex:1;
              height:60px;
              resize:none;
              padding:8px;
              border:1px solid #ccc;
              border-radius:8px;
            }

            #chat-input button {
              margin-left:10px;
              padding:8px 16px;
              border:none;
              background:#007bff;
              color:#fff;
              border-radius:8px;
              cursor:pointer;
            }

            #chat-input button:hover {
              background:#0056b3;
            }

            #contact-info {
              margin-top:15px;
              display:flex;
              gap:20px;
              align-items:center;
              flex-wrap:wrap;
              font-size:14px;
            }

            #contact-info div {
              display:flex;
              align-items:center;
              gap:5px;
            }

            #contact-info img {
              width:24px;
              height:24px;
            }
          </style>

          <div id="chat-wrapper">
            <div id="chat-container">
              <!-- Messages apparaîtront ici -->
            </div>

            <div id="chat-input">
              <textarea id="messageInput" placeholder="Écrire votre message..."></textarea>
              <button id="sendMessageBtn">Envoyer</button>
            </div>
          </div>



        </section>



        
      </div>
    </div>
  </main>
<footer style="background:#0303034f; padding:20px; text-align:center; font-family:Arial, sans-serif; color:#e8f805;">
  <div style="font-weight:bold; font-size:18px; margin-bottom:10px;">
    &copy; 2025 IASMarket Services. Tous droits réservés.
  </div>

  <div id="contact-info" style="display:flex; justify-content:center; gap:25px; flex-wrap:wrap; font-size:16px;">
    <div><i class="fa-solid fa-envelope" style="margin-right:8px; color:#007bff;"></i> contact@iasmarket.com</div>
    <div><i class="fa-brands fa-whatsapp" style="margin-right:8px; color:#25D366;"></i> +123456789</div>
    <div><i class="fa-brands fa-telegram" style="margin-right:8px; color:#0088cc;"></i> @IASMarket</div>
    <div><i class="fa-brands fa-facebook" style="margin-right:8px; color:#1877f2;"></i> /IASMarket</div>
    <div><i class="fa-solid fa-phone" style="margin-right:8px; color:#007bff;"></i> +987654321</div>
  </div>
</footer>



  <!-- Script onglets -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
  const panel = document.getElementById('panel-contact');
  if (!panel) return console.error("panel-contact introuvable");

  // ton code qui modifie panel.hidden ici
});

    const userEmail = localStorage.getItem('userEmail');
    (function () {
      const tablist = document.querySelector('[role="tablist"]');
      const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
      const panels = tabs.map(t => document.getElementById(t.getAttribute('aria-controls'))).filter(p => p);


      function activateTab(tab, focus = true) {
        tabs.forEach(t => {
          t.setAttribute('aria-selected', 'false');
          t.setAttribute('tabindex', '-1');
        });
        panels.forEach(p => p.hidden = true);

        tab.setAttribute('aria-selected', 'true');
        tab.removeAttribute('tabindex');
        const panel = document.getElementById(tab.getAttribute('aria-controls'));
        panel.hidden = false;
        if (focus) tab.focus();
      }

      tabs.forEach(tab => tab.addEventListener('click', () => activateTab(tab, false)));

      tablist.addEventListener('keydown', (e) => {
        const currentIndex = tabs.findIndex(t => t.getAttribute('aria-selected') === 'true');
        let nextIndex = null;
        switch (e.key) {
          case 'ArrowRight': nextIndex = (currentIndex + 1) % tabs.length; break;
          case 'ArrowLeft': nextIndex = (currentIndex - 1 + tabs.length) % tabs.length; break;
          case 'Home': nextIndex = 0; break;
          case 'End': nextIndex = tabs.length - 1; break;
          case 'Enter':
          case ' ': activateTab(tabs[currentIndex]); e.preventDefault(); return;
        }
        if (nextIndex !== null) { tabs[nextIndex].focus(); e.preventDefault(); }
      });
    })();
  </script>

  <!-- Script multilangue + API -->
  <script>
    // Traductions multilangue
    const translations = {
      fr: {
        'profile-title': "Mon Espace Privé",
        'DEMANDES':"DEMANDES",
        'contacter':"Contactez-nous",
        'infoperso':"Informations personnelles",
        'Négociation':"Négociation",
        'clas':"Espace personnel pour gérer vos commandes, vos informations et vos négociations de prix.",
        'connected-label': "Connecté en tant que :",
        'logoutBtn': "Déconnexion",
        'home': "Accueil",
        'title-annonces': "Demandes de publication",
        'title-achats': "Demandes d'achats",
        'title-recherches': "demandes de Recherche",
        'tableHeaders': ["Ref", "Date", "Marque", "Modèle", "Année", "CV", "Kilométrage", "Carburant", "Transmission", "Description", "Prix", "Valider", "Supprimer"],
        'no-data': "Aucune donnée",
        'confirm-del': "Supprimer l'élément Ref: {ref} ?",
        'edit-success': "État modifié: {val}",
        'edit-error': "Erreur lors de la modification.",
        'del-success': "Ref {ref} supprimé avec succès",
        'del-error': "Erreur lors de la suppression.",
        'load-success': "Données chargées",
        'session-expired': "Session expirée, reconnectez-vous",
        'not-connected': "Non connecté"
      },
      en: {
        'profile-title': "My Private Space",
        'DEMANDES':"Requests",
        'contacter':"Contactez-nous",
        'infoperso':"Informations personnelles",
        'Négociation':"Negotiation",
        'clas':"Personal space to manage your orders, your information, and your price negotiations.",
        'connected-label': "Logged in as:",
        'logoutBtn': "Logout",
        'home': "Home",
        'title-annonces': "Requests for Publication",
        'title-achats': "Purchase Requests",
        'title-recherches': "Inquiry Requests",
        'tableHeaders': ["Ref", "Date", "Brand", "Model", "Year", "HP", "Mileage", "Fuel", "Transmission", "Description", "Price", "Validate", "Delete"],
        'no-data': "No data",
        'confirm-del': "Delete item Ref: {ref}?",
        'edit-success': "Status changed: {val}",
        'edit-error': "Error during change.",
        'del-success': "Ref {ref} successfully deleted",
        'del-error': "Error during deletion.",
        'load-success': "Data loaded",
        'session-expired': "Session expired, please log in again",
        'not-connected': "Not connected"
      },
      ar: {
        'profile-title': "مساحتي الخاصة",
        'Négociation':"تفاوض",
        'contacter':"اتصل بنا",
        'infoperso':"المعلومات الشخصية",
        'DEMANDES':"الطلبات",
        'clas':"مساحتك الشخصية لإدارة طلباتك، ومعلوماتك، ومفاوضات الأسعار الخاصة بك.",
        'connected-label': "متصل باسم:",
        'logoutBtn': "تسجيل الخروج",
        'home': "الرئيسية",
        'title-annonces': "طلبات نشر إعلان",
        'title-achats': "طلبات الشراء",
        'title-recherches': "طلبات استعلام ",
        'tableHeaders': ["المرجع", "التاريخ", "الماركة", "الموديل", "السنة", "القوة", "الكيلومترات", "الوقود", "ناقل الحركة", "الوصف", "السعر", "تأكيد", "حذف"],
        'no-data': "لا توجد بيانات",
        'confirm-del': "حذف العنصر المرجع: {ref}؟",
        'edit-success': "تم تغيير الحالة: {val}",
        'edit-error': "خطأ أثناء التغيير.",
        'del-success': "تم حذف المرجع {ref} بنجاح",
        'del-error': "خطأ أثناء الحذف.",
        'load-success': "تم تحميل البيانات",
        'session-expired': "انتهت الجلسة، يرجى تسجيل الدخول مجددًا",
        'not-connected': "غير متصل"
      }
    };
    let currentLang = 'fr';
    function setLang(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.body.style.direction = (lang === 'ar' ? 'rtl' : 'ltr');
      document.getElementById("tab-demandes").textContent = translations[lang]['DEMANDES'];
      document.getElementById( 'tab-negoce').textContent = translations[lang]['Négociation'];
      document.getElementById( 'tab-infopers').textContent = translations[lang]['infoperso'];
      document.getElementById( 'tabcontactnous').textContent = translations[lang]['contacter'];
      
      document.getElementById('clas').textContent = translations[lang]['clas'];
      document.getElementById('profile-title').textContent = translations[lang]['profile-title'];
      document.getElementById('connected-label').textContent = translations[lang]['connected-label'];
      document.getElementById('logoutBtn').textContent = translations[lang]['logoutBtn'];
      document.getElementById('title-annonces').textContent = translations[lang]['title-annonces'];
      document.getElementById('title-achats').textContent = translations[lang]['title-achats'];
      document.getElementById('title-recherches').textContent = translations[lang]['title-recherches'];
      document.querySelector('.home-btn').innerHTML = `<i class="fas fa-home"></i> ${translations[lang]['home']}`;
      if (window.lastProfileData) {
        remplirTableau('table-annonces', window.lastProfileData.annonces || []);
        remplirTableau('table-achats', window.lastProfileData.achats || []);
        remplirTableau('table-recherches', window.lastProfileData.recherches || []);
      }
      ['fr','en','ar'].forEach(l=>{
        document.getElementById('lang-'+l).classList.remove('active');
      });
      document.getElementById('lang-'+lang).classList.add('active');
    }
    ['fr','en','ar'].forEach(l=>{
      document.getElementById('lang-'+l).addEventListener('click', () => setLang(l));
    });
    setLang('fr');
    (function(){
      const API_LOGIN = 'https://apicars.p2p-cars.com/api/login';
      const API_DELETE = 'https://apicars.p2p-cars.com/api/deletitem';
      const messageBox = document.getElementById('message');
      const btnLogout = document.getElementById('logoutBtn');
      const emailDisplay = document.getElementById('emailDisplay');
      const resultsSection = document.getElementById('results');
      function showMessage(type, text) {
        messageBox.innerHTML = '';
        const el = document.createElement('div');
        el.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'black');
        el.textContent = text;
        messageBox.appendChild(el);
      }
      function remplirTableau(idTable, data) {
        const table = document.getElementById(idTable);
        table.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          table.innerHTML = `<tr><td>${translations[currentLang]['no-data']}</td></tr>`;
          return;
        }
        let typeExcel = '';
        if (idTable === 'table-annonces') typeExcel = 'annonce';
        if (idTable === 'table-achats') typeExcel = 'achat';
        if (idTable === 'table-recherches') typeExcel = 'recherche';
        const headers = translations[currentLang]['tableHeaders'];
        const thead = document.createElement('thead');
        const htr = document.createElement('tr');
        headers.forEach(h => {
          const th = document.createElement('th');
          th.textContent = h;
          htr.appendChild(th);
        });
        thead.appendChild(htr);
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        data.forEach((item, idx) => {
          const tr = document.createElement('tr');
          const id = item.id;
          const ref = (item.Ref && item.Ref.trim() !== '') ? item.Ref : `#${idx + 1}`;
          const cells = [
            ref,
            item.date || '',
            item.marque || '',
            item.modele || '',
            item.annee || '',
            item.cv || '',
            item.kilometrage || '',
            item.carburant || '',
            item.transmission || '',
            item.description || '',
            item.prix || '',
          ];
          cells.forEach(c => {
            const td = document.createElement('td');
            td.textContent = c;
            tr.appendChild(td);
          });
          // Checkbox modification
          const tdValide = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = item.valide === 'oui' || item.valide === true;
          tdValide.appendChild(checkbox);
          tr.appendChild(tdValide);
          checkbox.addEventListener('change', async () => {
            const nouvelleValeur = checkbox.checked ? 'oui' : 'non';
            try {
              const resp = await fetch('https://apicars.p2p-cars.com/api/editdemande', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  id: id,
                  Ref: ref,
                  valide: nouvelleValeur,
                  table: typeExcel
                })
              });
              if (!resp.ok) throw new Error('Erreur serveur');
              showMessage('success', translations[currentLang]['edit-success'].replace('{val}', nouvelleValeur));
            } catch (err) {
              showMessage('error', translations[currentLang]['edit-error']);
              checkbox.checked = !checkbox.checked;
            }
          });
          // Suppression
          const tdDelete = document.createElement('td');
          const delIcon = document.createElement('i');
          delIcon.className = 'fa fa-trash icon-btn';
          delIcon.addEventListener('click', async () => {
            if (!confirm(translations[currentLang]['confirm-del'].replace('{ref}', ref))) return;
            try {
              const resp = await fetch(API_DELETE, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                  id: id,
                  Ref: ref,
                  table: typeExcel
                })
              });
              if (!resp.ok) throw new Error('Erreur serveur');
              tr.remove();
              showMessage('success', translations[currentLang]['del-success'].replace('{ref}', ref));
            } catch (err) {
              showMessage('error', translations[currentLang]['del-error']);
            }
          });
          tdDelete.appendChild(delIcon);
          tr.appendChild(tdDelete);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        resultsSection.style.display = 'block';
      }
      async function fetchProfile(email, password) {
        try {
          const resp = await fetch(API_LOGIN, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await resp.json();
          if (!resp.ok) throw new Error(data.message || 'Erreur serveur');
          emailDisplay.textContent = email;
          window.lastProfileData = data;
          remplirTableau('table-annonces', data.annonces || []);
          remplirTableau('table-achats', data.achats || []);
          remplirTableau('table-recherches', data.recherches || []);
          showMessage('success', translations[currentLang]['load-success']);
        } catch(err) {
          showMessage('error', translations[currentLang]['session-expired']);
          setTimeout(() => window.location.href = '/login.html', 3000);
        }
      }
      btnLogout.addEventListener('click', () => {
        localStorage.removeItem('p2p_email');
        localStorage.removeItem('p2p_pwd');
        window.location.href = '/login.html';
      });
      window.addEventListener('DOMContentLoaded', () => {
        const email = localStorage.getItem('p2p_email');
        const pwdEncoded = localStorage.getItem('p2p_pwd');
        if (!email || !pwdEncoded) {
          showMessage('error', translations[currentLang]['not-connected']);
          setTimeout(() => window.location.href = '/login.html', 2000);
          return;
        }
        fetchProfile(email, atob(pwdEncoded));
      });
    })();
  </script>

  <script>
document.getElementById('tab-negoce').addEventListener('click', async function() {
    // Récupère le userId depuis l'attribut data-userid
    const userId = userEmail;

    try {
        // Envoie du userId via POST (ou GET selon ton API)
        const response = await fetch('https://apicars.p2p-cars.com/api/userforums', {
            method: 'POST', // ou 'GET'
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ userId }) // pour POST
        });

        if (!response.ok) {
            throw new Error(`Erreur HTTP : ${response.status}`);
        }

        const data = await response.json();
        afficherForums(data);
        // Ici tu peux faire ce que tu veux avec les données

    } catch (error) {
        console.error('Erreur lors de l\'appel API:', error);
    }
});

// Fonction pour créer les forums
function afficherForums(data) {
    const panel = document.getElementById("panel-negoce");
    panel.innerHTML = ""; // vider avant d'ajouter

    data.forEach((forum, index) => {
        const forumDiv = document.createElement("div");
        forumDiv.className = "forum";

        // Partie gauche : titre, discussion, zone message
        const leftDiv = document.createElement("div");
        leftDiv.className = "forum-left";

        const title = document.createElement("div");
        title.className = "forum-title";
        title.textContent = forum.title;

        const discussion = document.createElement("div");
        discussion.className = "forum-discussion";

        if (Array.isArray(forum.messages)) {
            discussion.innerHTML = forum.messages
                .map(m => `<div>${m.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`)
                .join("");
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = "forum-message";
        const textarea = document.createElement("textarea");
        const sendBtn = document.createElement("button");
        sendBtn.textContent = "Envoyer";
        sendBtn.onclick = async () => {
            const msg = textarea.value.trim();
            if (msg) {
                const newMsg = document.createElement("div");
                newMsg.textContent = msg;
                const email = localStorage.getItem('userEmail');
                
                
                const dataf = {
                    Ref: forum.title ,
                    email: email,
                    poffre:"-",
                    message: msg
                };
                try {
                    const response = await fetch('https://apicars.p2p-cars.com/api/msgsellr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataf)
                    });
                    if (response.ok) {
                        alert("Message envoyé !");
                        
                    } else {
                        const errorData = await response.json();
                        alert("Erreur lors de l'envoi : " + (errorData.message || response.status));
                    }
                } catch (error) {
                    alert("Impossible d'envoyer le message. Vérifiez votre connexion.");
                }
                discussion.appendChild(newMsg);
                textarea.value = "";
            }
        };
        
        messageDiv.appendChild(textarea);
        messageDiv.appendChild(sendBtn);

        leftDiv.appendChild(title);
        leftDiv.appendChild(discussion);
        leftDiv.appendChild(messageDiv);

        // Partie droite : infos voiture
        const rightDiv = document.createElement("div");
        rightDiv.className = "forum-right";
if (forum.voiture) {
    rightDiv.innerHTML = `
        <div style="
            position: relative; 
            width: 100%; 
            height: 100%; 
            overflow: hidden;
            border-radius: 8px;
        ">
            ${forum.voiture.image 
                ? `<img src="https://p2p-cars.com/${forum.voiture.image.replace(/\\/g, '/')}" 
                       alt="voiture" 
                       style="width:100%; height:100%; object-fit:cover; display:block;">` 
                : ''}

            <div style="
                position: absolute; 
                bottom: 0; 
                left: 0; 
                width: 100%; 
                background: rgba(0,0,0,0.5); 
                color: yellow; 
                font-weight: bold; 
                padding: 8px; 
                font-size: 14px;
            ">
                ${forum.voiture.marque} ${forum.voiture.modele},
                Année: ${forum.voiture.annee},
                CV: ${forum.voiture.cv},
                Prix: ${forum.voiture.prix},
                Carburant: ${forum.voiture.carburant},
                ${forum.voiture.description || ''}
            </div>
        </div>
    `;
} else {
    rightDiv.textContent = "Aucune info voiture";
}

        forumDiv.appendChild(leftDiv);
        forumDiv.appendChild(rightDiv);
        panel.appendChild(forumDiv);

        // Séparateur sauf après le dernier forum
        if (index < data.length - 1) {
            const sep = document.createElement("div");
            sep.className = "separator";
            panel.appendChild(sep);
        }
    });

    panel.hidden = false; // afficher la section
}
/////////////////////////
document.getElementById('tab-infopers').addEventListener('click', async function() {
  const panel = document.getElementById('panel-contact');

  if (!userEmail) return alert("Veuillez entrer votre email");

  panel.innerHTML = `
    <p>Veuillez entrer votre mot de passe pour accéder à vos informations personnelles.</p>
    <input type="password" id="passwordInput" placeholder="Mot de passe" style="margin-right:10px;">
    <button id="submitPassword">Valider</button>
  `;
  panel.hidden = false;

  document.getElementById('submitPassword').addEventListener('click', async function() {
    const password = document.getElementById('passwordInput').value;
    if (!password) return alert("Veuillez entrer votre mot de passe");

    try {
      // --- Login pour obtenir JWT ---
      const loginResponse = await fetch('https://apicars.p2p-cars.com/api/Auht0', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: userEmail, password })
      });
      if (!loginResponse.ok) throw new Error("Erreur login: " + loginResponse.status);
      const { token } = await loginResponse.json();
      if (!token) return alert("Mot de passe incorrect");

      console.log("[Frontend] JWT obtenu :", token);

      // --- Fetch infos utilisateur ---
      const response = await fetch('https://apicars.p2p-cars.com/api/fusers', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        }
      });
      const data = await response.json();

      // --- Images CIN en base64 ---
      let imgHtml = `<p><em>Aucune image CIN disponible</em></p>`;
      if (Array.isArray(data.imgcin) && data.imgcin.length > 0) {
        imgHtml = `<p><strong>Carte CIN :</strong></p>
                   <div style="display:flex; gap:15px; justify-content:center; flex-wrap:wrap;">`;
        for (let i = 0; i < data.imgcin.length; i++) {
          const base64Res = await fetch(data.imgcin[i] + '/base64', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (base64Res.ok) {
            const { base64 } = await base64Res.json();
            imgHtml += `<img src="${base64}" alt="CIN ${i === 0 ? 'Recto' : 'Verso'}" 
                        style="max-width:440px; max-height:440px; object-fit:contain; border:1px solid #ccc; border-radius:8px;">`;
          }
        }
        imgHtml += `</div>`;
      }

      // --- Étoiles d'évaluation ---
      let stars = "";
      let points = parseInt(data.comport) || 0;
      let fullStars = Math.floor(points / 5);
      for (let i = 0; i < 5; i++) {
        stars += i < fullStars ? "&#9733;" : "&#9734;";
      }

      // --- Affichage infos utilisateur dans zones de texte avec boutons ---
      const html = `
        <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap: wrap;">
          <div style="flex:1; min-width:250px;">
            ${createEditableField('Email', 'id', data.id)}
            ${createEditableField('Nom complet', 'nom', data.nom)}
            ${createEditableField('N° CIN', 'cin', data.cin)}
            ${createEditableField('Téléphone', 'telephone', data.telephone)}
            <p><strong>Publications activées:</strong> ${data.appels || ""}</p>
            <p><strong>Évaluation:</strong> <span style="font-size:20px; color:gold;">${stars}</span> (${points}/25)</p>
          </div>
          <div style="flex:1; min-width:250px; text-align:center;">
            ${imgHtml}
          </div>
        </div>
        <div style="margin-top:20px; text-align:center;">
          <button id="changePasswordBtn" style="padding:8px 15px; border:none; background:#007bff; color:white; border-radius:6px; cursor:pointer;">
            Changer le mot de passe
          </button>
          <div id="passwordChangePanel" style="margin-top:15px; display:none;">
            <input type="password" id="newPasswordInput" placeholder="Nouveau mot de passe" style="margin-right:10px;">
            <button id="submitNewPassword">Valider</button>
          </div>
        </div>
      `;
      panel.innerHTML = html;

      // --- Gestion bouton changement mot de passe ---
      document.getElementById("changePasswordBtn").addEventListener("click", function() {
        document.getElementById("passwordChangePanel").style.display = "block";
      });

      document.getElementById("submitNewPassword").addEventListener("click", async function() {
        const newPassword = document.getElementById("newPasswordInput").value;
        if (!newPassword) return alert("Veuillez entrer le nouveau mot de passe");

        try {
          const updateResponse = await fetch('https://apicars.p2p-cars.com/api/change-password', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ email: userEmail, newPassword })
          });
          if (!updateResponse.ok) throw new Error("Erreur modification: " + updateResponse.status);
          alert("Mot de passe changé avec succès !");
          document.getElementById("passwordChangePanel").style.display = "none";

        } catch (err) {
          console.error(err);
          alert("Impossible de changer le mot de passe.");
        }
      });

      // --- Gestion boutons modifier/enregistrer/annuler ---
      setupEditableFields(token, data);

    } catch (err) {
      console.error(err);
      panel.innerHTML = `<p style="color:red;">Impossible de charger les informations.</p>`;
    }
  });
});

// --- Fonctions utilitaires ---
function createEditableField(label, fieldId, value) {
  return `
    <div style="margin-bottom:10px;">
      <p><strong>${label}:</strong></p>
      <input type="text" id="${fieldId}Input" value="${value}" disabled style="width:100%; margin-bottom:5px;">
      <div>
        <button id="${fieldId}EditBtn">Modifier</button>
        <button id="${fieldId}SaveBtn" style="display:none;">Enregistrer</button>
        <button id="${fieldId}CancelBtn" style="display:none;">Annuler</button>
      </div>
    </div>
  `;
}

function setupEditableFields(token, originalData) {
  ['id','nom','cin','telephone'].forEach(field => {
    const input = document.getElementById(field + 'Input');
    const editBtn = document.getElementById(field + 'EditBtn');
    const saveBtn = document.getElementById(field + 'SaveBtn');
    const cancelBtn = document.getElementById(field + 'CancelBtn');

    editBtn.addEventListener('click', () => {
      input.disabled = false;
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
    });

    cancelBtn.addEventListener('click', () => {
      input.value = originalData[field] || '';
      input.disabled = true;
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
    });

    saveBtn.addEventListener('click', async () => {
      const newValue = input.value;
      try {
        const updateResponse = await fetch('https://apicars.p2p-cars.com/api/updatinfo', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ email: userEmail, [field]: newValue })
        });
        if (!updateResponse.ok) throw new Error("Erreur update: " + updateResponse.status);
        originalData[field] = newValue;
        input.disabled = true;
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        alert(`${field} mis à jour avec succès !`);
      } catch (err) {
        console.error(err);
        alert("Impossible de mettre à jour " + field);
      }
    });
  });
}

////////////////////////////////////////////
let chatInterval;


document.getElementById('tabcontactnous').addEventListener("click", async () => {
  try {
    const response = await fetch("https://apicars.p2p-cars.com/api/supportusers", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: userEmail }),
    });

    if (!response.ok) throw new Error("Erreur réseau: " + response.status);

    const data = await response.json();
    document.getElementById('panel-contactnous').hidden = false;

    renderMessages(data.messages);

    if (!chatInterval) {
      chatInterval = setInterval(refreshChat, 5000);
    }
  } catch (error) {
    console.error("Erreur lors de l'ouverture du chat :", error);
  }
});

async function refreshChat() {
  const panel = document.getElementById('panel-contactnous');
  if (panel.hidden) {
    clearInterval(chatInterval);
    chatInterval = null;
    return;
  }

  try {
    const response = await fetch("https://apicars.p2p-cars.com/api/supportusers", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: userEmail }),
    });

    if (!response.ok) throw new Error("Erreur réseau: " + response.status);

    const data = await response.json();
    renderMessages(data.messages);

  } catch (err) {
    console.error("Erreur lors du rafraîchissement du chat :", err);
  }
}

function renderMessages(messages) {
  const chatContainer = document.getElementById('chat-container');
  chatContainer.innerHTML = ""; // reset

  messages.forEach(msg => {
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message");

    if (msg.editeur === "support") {
      msgDiv.classList.add("support-message");
    } else {
      msgDiv.classList.add("user-message");
    }

    msgDiv.textContent = msg.message;
    chatContainer.appendChild(msgDiv);
  });

  chatContainer.scrollTop = chatContainer.scrollHeight;
}

document.getElementById('sendMessageBtn').addEventListener('click', async function() {
  const input = document.getElementById('messageInput');
  const messageText = input.value.trim();
  if (!messageText || !userEmail) return;

  try {
    const response = await fetch('https://apicars.p2p-cars.com/api/sendmsgsupport', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: messageText, userEmail })
    });

    const data = await response.json();

    if (data.success) {
      input.value = '';
      await refreshChat(); // recharge l'historique après envoi
    } else {
      console.error('Erreur API:', data.message);
    }
  } catch (err) {
    console.error('Erreur en envoyant le message:', err);
  }
});

////////////////////////////

</script>
</body>
</html>
