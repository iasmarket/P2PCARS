<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P-CARS - Connexion</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #3b82f6;
      --blue-dark: #2563eb;
      --bg-input: #1e293b;
      --text: #e2e8f0;
      --muted: rgba(226,232,240,0.85);
      --error: #ff6b6b;
      --success: #34d399;
    }

    html,body{height:100%;}
    body {
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.301), rgba(30, 41, 59, 0.247)),
                url('arier.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 14px 10px 20px 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      gap: 40px;
    }
    header img { max-height:110px; transition:transform .25s; }
    header img:hover { transform: scale(1.05); }
    header h1 { font-size:2.4rem; color:var(--blue); margin:0; }
    header .text-h { color:var(--text); margin:0; }

    .form-section {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(11px);
      border-radius: 15px;
      max-width: 520px;
      margin: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.20);
      padding: 28px 22px;
      margin-bottom: 20px;
    }
    .form-section h2 { text-align:center; color:var(--blue); margin-top:0; }

    form label { display:block; font-weight:500; margin-bottom:6px; }
    input[type="email"], input[type="password"] {
      width:100%;
      padding:10px;
      border-radius:7px;
      border:1px solid #334155;
      background:var(--bg-input);
      color:var(--text);
      font-size:1rem;
      box-sizing:border-box;
    }
    input:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); border-color: var(--blue); }

    .input-error { border-color: var(--error) !important; box-shadow: none; }
    .error-text { color: var(--error); font-size:0.85rem; margin-top:6px; }
    .success-text { color: var(--success); font-size:0.95rem; margin-top:6px; }

    .checkbox-container {
      display:flex; align-items:center; gap:10px;
      font-size:0.95rem; cursor:pointer; user-select:none; margin-top:8px;
    }
    .checkbox-container input[type="checkbox"] {
      appearance:none; width:18px; height:18px; border:2px solid var(--blue);
      border-radius:4px; position:relative; cursor:pointer; background:transparent;
    }
    .checkbox-container input[type="checkbox"]:checked {
      background:var(--blue); border-color:var(--blue);
    }
    .checkbox-container input[type="checkbox"]:checked::after{
      content:"\2713"; position:absolute; left:3px; top:-1px; color:#fff; font-size:12px;
    }
    .checkbox-container:hover input[type="checkbox"]{ border-color:var(--blue-dark); }

    button[type="submit"]{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--blue); color:#fff; border:none; padding:10px 18px; border-radius:7px;
      font-weight:600; cursor:pointer; margin-top:12px; font-size:1rem;
    }
    button[disabled]{ opacity:0.7; cursor:not-allowed; }

    /* spinner */
    .spinner {
      width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.35);
      border-top-color: #fff; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #message { margin-top:12px; text-align:center; min-height:20px; }
    #message .text { display:inline-block; padding:8px 12px; border-radius:8px; font-weight:600; }

    #results { max-width:95%; margin:auto; display:none; }

    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:0.92rem; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
    th { background: rgba(59,130,246,0.12); color:#fff; font-weight:600; }
    tr:hover { background: rgba(59,130,246,0.06); }

    /* small helpers */
    .muted { color:var(--muted); font-size:0.92rem; text-align:center; margin-top:10px; }
    @media (max-width:720px){
      header { flex-direction:column; text-align:center; gap:12px; }
      .form-section{ margin:12px; padding:18px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo1.png" alt="Logo société mère">
    <div class="header-center">
      <h1>P2P-CARS</h1>
      <p class="text-h">Connexion à votre compte</p>
    </div>
    <img src="logo4.png" alt="Logo plateforme">
  </header>

  <section class="form-section" aria-labelledby="title-connexion">
    <h2 id="title-connexion">Connexion</h2>

    <form id="loginForm" novalidate>
      <label for="email">Email :</label>
      <input type="email" id="email" name="email" autocomplete="username" required aria-describedby="emailError" />
      <div id="emailError" class="error-text" aria-live="polite"></div>

      <label for="password">Mot de passe :</label>
      <input type="password" id="password" name="password" autocomplete="current-password" required aria-describedby="passwordError" />
      <div id="passwordError" class="error-text" aria-live="polite"></div>

      <label class="checkbox-container" for="rememberMe">
        <input type="checkbox" id="rememberMe" name="rememberMe" checked />
        Rester connecté
      </label>

      <button type="submit" id="submitBtn" aria-live="polite">
        <span id="btnContent"><i class="fas fa-sign-in-alt"></i> Se connecter</span>
      </button>

      <!-- Bouton Déconnexion -->
      <button id="logoutBtn" style="display:none; background:#ef4444; color:white; border:none; padding:8px 16px; border-radius:7px; cursor:pointer; margin:10px auto; display:block;">
        <i class="fas fa-sign-out-alt"></i> Déconnexion
      </button>

      <!-- Lien mot de passe oublié -->
      <p style="text-align:center; margin-top:10px;">
        <a href="#" id="forgotPassword" style="color:#3b82f6; font-size:0.9rem;">Mot de passe oublié ?</a>
      </p>
    </form>

    <!-- message global (erreur / succès) -->
    <div id="message" role="status" aria-live="polite"></div>

    <p class="muted">
      Vous aurez votre compte en remplissant l’un des formulaires de service
      <a href="index.html" style="color:var(--blue); text-decoration:underline;">cliquer ici</a>.
    </p>
  </section>

  <div id="results">
    <h2>Tableau des Annonces</h2>
    <table id="table-annonces" role="table" aria-label="Annonces"></table>

    <h2>Tableau des Demandes d'Achat</h2>
    <table id="table-achats" role="table" aria-label="Achats"></table>

    <h2>Tableau des Demandes de Recherche</h2>
    <table id="table-recherches" role="table" aria-label="Recherches"></table>
  </div>

  <footer style="text-align:center; margin: 20px 0; color: #e2e8f0;">
    &copy; 2025 IASMarket Services. Tous droits réservés.
  </footer>

<script>
(function () {
  // URLs API utilisées
  const API_LOGIN = 'https://apicars.p2p-cars.com/api/login';
  const API_FORGOT = 'https://apicars.p2p-cars.com/api/loginrest';
  const API_EDIT = 'https://apicars.p2p-cars.com/api/editdemande';

  // Références aux éléments DOM
  const form = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const rememberCheckbox = document.getElementById('rememberMe');
  const submitBtn = document.getElementById('submitBtn');
  const btnContent = document.getElementById('btnContent');
  const messageDiv = document.getElementById('message');
  const logoutBtn = document.getElementById('logoutBtn');
  const forgotPasswordLink = document.getElementById('forgotPassword');

  // Tables résultats
  const tableAnnonces = document.getElementById('table-annonces');
  const tableAchats = document.getElementById('table-achats');
  const tableRecherches = document.getElementById('table-recherches');
  const resultsDiv = document.getElementById('results');

  // Validation simple email
  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // Affiche un message d'erreur sous l'input
  function showInputError(input, message) {
    const errorDiv = document.getElementById(input.id + 'Error');
    if (message) {
      input.classList.add('input-error');
      errorDiv.textContent = message;
    } else {
      input.classList.remove('input-error');
      errorDiv.textContent = '';
    }
  }

  // Affiche message global
  function showMessage(message, type = 'error') {
    messageDiv.textContent = '';
    messageDiv.className = '';
    if (!message) return;
    const span = document.createElement('span');
    span.classList.add('text');
    if (type === 'error') {
      span.style.backgroundColor = 'rgba(255,107,107,0.9)';
      span.style.color = '#fff';
    } else if (type === 'success') {
      span.style.backgroundColor = 'rgba(52,211,153,0.9)';
      span.style.color = '#fff';
    }
    span.textContent = message;
    messageDiv.appendChild(span);
  }

  // Active/désactive le bouton submit
  function setSubmitDisabled(disabled) {
    submitBtn.disabled = disabled;
    if (disabled) {
      btnContent.innerHTML = '<div class="spinner" aria-label="Chargement en cours"></div>';
    } else {
      btnContent.innerHTML = '<i class="fas fa-sign-in-alt"></i> Se connecter';
    }
  }

  // Nettoie les tableaux résultats
  function clearResults() {
    tableAnnonces.innerHTML = '';
    tableAchats.innerHTML = '';
    tableRecherches.innerHTML = '';
    resultsDiv.style.display = 'none';
  }

  // Affiche les tableaux de données
  function displayTables(data) {
    clearResults();
    resultsDiv.style.display = 'block';

    // Fonction d'affichage générique d'une table à partir d'un tableau d'objets
    function fillTable(table, array, title) {
      if (!Array.isArray(array) || array.length === 0) {
        table.innerHTML = '<tr><td>Aucune donnée disponible</td></tr>';
        return;
      }

      // Entêtes : toutes les clés de l'objet
      const headers = Object.keys(array[0]);
      let theadHTML = '<thead><tr>';
      headers.forEach(h => { theadHTML += `<th>${h}</th>`; });
      theadHTML += '</tr></thead>';

      // Corps
      let tbodyHTML = '<tbody>';
      array.forEach(item => {
        tbodyHTML += '<tr>';
        headers.forEach(h => {
          tbodyHTML += `<td>${item[h]}</td>`;
        });
        tbodyHTML += '</tr>';
      });
      tbodyHTML += '</tbody>';

      table.innerHTML = theadHTML + tbodyHTML;
    }

    fillTable(tableAnnonces, data.annonces || [], 'Annonces');
    fillTable(tableAchats, data.achats || [], 'Achats');
    fillTable(tableRecherches, data.recherches || [], 'Recherches');
  }

  // Fonction connexion
  async function login(email, password) {
    setSubmitDisabled(true);
    showMessage('');

    try {
      const response = await fetch(API_LOGIN, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Erreur lors de la connexion');
      }

      const data = await response.json();

      // Vérifie que la réponse contient bien ce qu'on attend
      if (!data.token || !data.user) {
        throw new Error('Réponse API incomplète');
      }

      // Sauvegarde dans localStorage si demandé
      if (rememberCheckbox.checked) {
        // Stocker email + token seulement, jamais le mot de passe en clair
        localStorage.setItem('userEmail', email);
        localStorage.setItem('userToken', data.token);
      } else {
        // Supprime si décoché
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userToken');
      }

      // Affiche tableaux si présents
      if (data.annonces || data.achats || data.recherches) {
        displayTables(data);
      } else {
        clearResults();
      }

      // Affiche bouton déconnexion et cache le formulaire
      logoutBtn.style.display = 'block';
      form.style.display = 'none';

      showMessage('Connexion réussie !', 'success');

    } catch (error) {
      showMessage(error.message || 'Erreur lors de la connexion', 'error');
      clearResults();
    } finally {
      setSubmitDisabled(false);
    }
  }

  // Déconnexion simple
  function logout() {
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userToken');
    clearResults();
    showMessage('Vous êtes déconnecté.', 'success');
    logoutBtn.style.display = 'none';
    form.style.display = 'block';
  }

  // Validation du formulaire
  function validateForm() {
    let valid = true;

    if (!emailInput.value.trim()) {
      showInputError(emailInput, 'Veuillez saisir votre email.');
      valid = false;
    } else if (!isValidEmail(emailInput.value.trim())) {
      showInputError(emailInput, 'Email invalide.');
      valid = false;
    } else {
      showInputError(emailInput, '');
    }

    if (!passwordInput.value.trim()) {
      showInputError(passwordInput, 'Veuillez saisir votre mot de passe.');
      valid = false;
    } else {
      showInputError(passwordInput, '');
    }

    return valid;
  }

  // Auto login si stockage local
  async function autoLoginIfStored() {
    const storedEmail = localStorage.getItem('userEmail');
    const storedToken = localStorage.getItem('userToken');

    if (storedEmail && storedToken) {
      // Ici, on peut essayer de valider le token via une requête API si disponible
      // Pour l'exemple, on simule que la session est valide
      showMessage('Connexion automatique...', 'success');

      // Affiche bouton déconnexion et cache formulaire
      logoutBtn.style.display = 'block';
      form.style.display = 'none';

      // Idéalement, récupérer aussi les données (annonces, achats, recherches) en faisant une requête API avec le token
      // Sinon, afficher un message et proposer à l'utilisateur de se reconnecter

      // Pour la démo, on ne récupère pas les tableaux
    }
  }

  // Événements
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!validateForm()) return;

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    await login(email, password);
  });

  logoutBtn.addEventListener('click', () => {
    logout();
  });

  forgotPasswordLink.addEventListener('click', async (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();
    if (!email) {
      showMessage('Veuillez saisir votre email pour récupérer le mot de passe.', 'error');
      return;
    }
    if (!isValidEmail(email)) {
      showMessage('Email invalide.', 'error');
      return;
    }

    showMessage('Demande de récupération envoyée...', 'success');

    try {
      const response = await fetch(API_FORGOT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'Erreur lors de la récupération');
      }

      showMessage('Un email de récupération a été envoyé.', 'success');
    } catch (error) {
      showMessage(error.message || 'Erreur lors de la récupération', 'error');
    }
  });

  // Initialisation
  autoLoginIfStored();
})();
</script>
</body>
</html>
