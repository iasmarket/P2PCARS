<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>P2P-CARS - Connexion</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #3b82f6;
      --blue-dark: #2563eb;
      --bg-input: #1e293b;
      --text: #e2e8f0;
      --muted: rgba(226,232,240,0.85);
      --error: #ff6b6b;
      --success: #34d399;
    }

    html,body{height:100%;}
    body {
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.301), rgba(30, 41, 59, 0.247)),
                url('arier.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: rgba(255,255,255,0.07);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 18px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 14px 10px 20px 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
      gap: 40px;
    }
    header img { max-height:110px; transition:transform .25s; }
    header img:hover { transform: scale(1.05); }
    header h1 { font-size:2.4rem; color:var(--blue); margin:0; }
    header .text-h { color:var(--text); margin:0; }

    .form-section {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(11px);
      border-radius: 15px;
      max-width: 520px;
      margin: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.20);
      padding: 28px 22px;
      margin-bottom: 20px;
    }
    .form-section h2 { text-align:center; color:var(--blue); margin-top:0; }

    form label { display:block; font-weight:500; margin-bottom:6px; }
    input[type="email"], input[type="password"] {
      width:100%;
      padding:10px;
      border-radius:7px;
      border:1px solid #334155;
      background:var(--bg-input);
      color:var(--text);
      font-size:1rem;
      box-sizing:border-box;
    }
    input:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); border-color: var(--blue); }

    .input-error { border-color: var(--error) !important; box-shadow: none; }
    .error-text { color: var(--error); font-size:0.85rem; margin-top:6px; }
    .success-text { color: var(--success); font-size:0.95rem; margin-top:6px; }

    .checkbox-container {
      display:flex; align-items:center; gap:10px;
      font-size:0.95rem; cursor:pointer; user-select:none; margin-top:8px;
    }
    .checkbox-container input[type="checkbox"] {
      appearance:none; width:18px; height:18px; border:2px solid var(--blue);
      border-radius:4px; position:relative; cursor:pointer; background:transparent;
    }
    .checkbox-container input[type="checkbox"]:checked {
      background:var(--blue); border-color:var(--blue);
    }
    .checkbox-container input[type="checkbox"]:checked::after{
      content:"\2713"; position:absolute; left:3px; top:-1px; color:#fff; font-size:12px;
    }
    .checkbox-container:hover input[type="checkbox"]{ border-color:var(--blue-dark); }

    button[type="submit"]{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--blue); color:#fff; border:none; padding:10px 18px; border-radius:7px;
      font-weight:600; cursor:pointer; margin-top:12px; font-size:1rem;
    }
    button[disabled]{ opacity:0.7; cursor:not-allowed; }

    /* spinner */
    .spinner {
      width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.35);
      border-top-color: #fff; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #message { margin-top:12px; text-align:center; min-height:20px; }
    #message .text { display:inline-block; padding:8px 12px; border-radius:8px; font-weight:600; }

    #results { max-width:95%; margin:auto; display:none; }

    table { width:100%; border-collapse:collapse; margin-top:12px; font-size:0.92rem; background:rgba(255,255,255,0.03); border-radius:8px; overflow:hidden; }
    th, td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; vertical-align:top; }
    th { background: rgba(59,130,246,0.12); color:#fff; font-weight:600; }
    tr:hover { background: rgba(59,130,246,0.06); }

    /* small helpers */
    .muted { color:var(--muted); font-size:0.92rem; text-align:center; margin-top:10px; }
    @media (max-width:720px){
      header { flex-direction:column; text-align:center; gap:12px; }
      .form-section{ margin:12px; padding:18px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo1.png" alt="Logo société mère">
    <div class="header-center">
      <h1>P2P-CARS</h1>
      <p class="text-h">Connexion à votre compte</p>
    </div>
    <img src="logo4.png" alt="Logo plateforme">
  </header>

  <section class="form-section" aria-labelledby="title-connexion">
    <h2 id="title-connexion">Connexion</h2>

    <form id="loginForm" novalidate>
      <label for="email">Email :</label>
      <input type="email" id="email" name="email" autocomplete="username" required aria-describedby="emailError">
      <div id="emailError" class="error-text" aria-live="polite"></div>

      <label for="password">Mot de passe :</label>
      <input type="password" id="password" name="password" autocomplete="current-password" required aria-describedby="passwordError">
      <div id="passwordError" class="error-text" aria-live="polite"></div>

      <label class="checkbox-container" for="rememberMe">
        <input type="checkbox" id="rememberMe" name="rememberMe" checked>
        Rester connecté
      </label>

      <button type="submit" id="submitBtn" aria-live="polite">
        <span id="btnContent"><i class="fas fa-sign-in-alt"></i> Se connecter</span>
      </button>
      <!-- Bouton Déconnexion -->
      <button id="logoutBtn" style="display:none; background:#ef4444; color:white; border:none; padding:8px 16px; border-radius:7px; cursor:pointer; margin:10px auto; display:block;">
        <i class="fas fa-sign-out-alt"></i> Déconnexion
      </button>

      <!-- Lien mot de passe oublié -->
      <p style="text-align:center; margin-top:10px;">
        <a href="#" id="forgotPassword" style="color:#3b82f6; font-size:0.9rem;">Mot de passe oublié ?</a>
      </p>

    </form>

    <!-- message global (erreur / succès) -->
    <div id="message" role="status" aria-live="polite"></div>

    <p class="muted">
      Vous aurez votre compte en remplissant l’un des formulaires de service
      <a href="index.html" style="color:var(--blue); text-decoration:underline;">cliquer ici</a>.
    </p>
  </section>

  <div id="results">
    <h2>Tableau des Annonces</h2>
    <table id="table-annonces" role="table" aria-label="Annonces"></table>

    <h2>Tableau des Demandes d'Achat</h2>
    <table id="table-achats" role="table" aria-label="Achats"></table>

    <h2>Tableau des Demandes de Recherche</h2>
    <table id="table-recherches" role="table" aria-label="Recherches"></table>
  </div>

  <footer style="text-align:center; margin: 20px 0; color: #e2e8f0;">
    &copy; 2025 IASMarket Services. Tous droits réservés.
  </footer>

<script>
(function () {
  const API_LOGIN = 'https://apicars.p2p-cars.com/api/login';
  const API_FORGOT = 'https://apicars.p2p-cars.com/api/loginrest';
  const API_EDIT = 'https://apicars.p2p-cars.com/api/editdemande';

  const form = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const rememberInput = document.getElementById('rememberMe');
  const submitBtn = document.getElementById('submitBtn');
  const btnContent = document.getElementById('btnContent');
  const messageBox = document.getElementById('message');
  const emailError = document.getElementById('emailError');
  const passwordError = document.getElementById('passwordError');
  const btnLogout = document.getElementById('logoutBtn');
  const forgotLink = document.getElementById('forgotLink');

  /** ======= UTILS ======= **/

  // Affiche un message avec styles selon type
  function showMessage(type, text) {
    messageBox.innerHTML = '';
    const el = document.createElement('div');
    el.className = 'text';
    if (type === 'error') {
      el.style.background = 'rgba(255,107,107,0.12)';
      el.style.color = 'var(--error)';
    } else if (type === 'success') {
      el.style.background = 'rgba(52,211,153,0.12)';
      el.style.color = 'var(--success)';
    } else {
      el.style.background = 'rgba(255,255,255,0.03)';
      el.style.color = 'var(--muted)';
    }
    el.textContent = text;
    messageBox.appendChild(el);
  }

  // Nettoie les erreurs visuelles sur champs
  function clearFieldErrors() {
    emailError.textContent = '';
    passwordError.textContent = '';
    emailInput.classList.remove('input-error');
    passwordInput.classList.remove('input-error');
  }

  // Affiche erreur sur un champ spécifique
  function setFieldError(inputEl, errorEl, message) {
    inputEl.classList.add('input-error');
    errorEl.textContent = message;
  }

  // Active/désactive le bouton et change son texte
  function setLoading(loading) {
    if (loading) {
      submitBtn.disabled = true;
      btnContent.innerHTML = '<span class="spinner"></span> Connexion…';
    } else {
      submitBtn.disabled = false;
      btnContent.innerHTML = '<i class="fas fa-sign-in-alt"></i> Se connecter';
    }
  }

  // Remplissage des tableaux avec données reçues
  function remplirTableau(idTable, data) {
    const table = document.getElementById(idTable);
    table.innerHTML = '';

    if (!Array.isArray(data) || data.length === 0) {
      table.innerHTML = '<tr><td>Aucune donnée</td></tr>';
      return;
    }

    const headers = [
      "Ref", "Date", "Marque", "Modèle", "Année", "CV", "Kilométrage",
      "Carburant", "Transmission", "Description", "Prix", "Valider"
    ];
    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      htr.appendChild(th);
    });
    thead.appendChild(htr);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    data.forEach(item => {
      const tr = document.createElement('tr');

      // Colonnes texte
      const textCells = [
        item.Ref || item.ref || '',
        item.date || '',
        item.marque || '',
        item.modele || '',
        item.annee || '',
        item.cv || '',
        item.kilometrage || '',
        item.carburant || '',
        item.transmission || '',
        item.description || '',
        item.prix || ''
      ];

      textCells.forEach(c => {
        const td = document.createElement('td');
        td.textContent = c;
        tr.appendChild(td);
      });

      // Colonne checkbox "Valider"
      const tdValide = document.createElement('td');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.checked = String(item.valide).toLowerCase() === 'oui' || item.valide === true;
      chk.addEventListener('change', () => {
        fetch(API_EDIT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ref: item.Ref || item.ref,
            valide: chk.checked ? 'Oui' : 'Non'
          })
        }).then(r => r.json())
          .then(() => showMessage('success', 'Mise à jour réussie'))
          .catch(() => showMessage('error', 'Erreur lors de la mise à jour'));
      });
      tdValide.appendChild(chk);
      tr.appendChild(tdValide);

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
  }

  // Affiche l'interface avec données (après connexion ou reload)
  function afficherInterface(data) {
    document.getElementById('results').style.display = 'block';
    btnLogout.style.display = 'inline-block';
    remplirTableau('table-annonces', data.annonces || []);
    remplirTableau('table-achats', data.achats || []);
    remplirTableau('table-recherches', data.recherches || []);
  }

  // Fonction connexion avec API + stockage session
  async function loginUser(email, password) {
    setLoading(true);
    showMessage('info', 'Connexion en cours...');
    try {
      const resp = await fetch(API_LOGIN, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.message || 'Erreur serveur');

      // Stockage dans localStorage uniquement si "Se souvenir"
      if (rememberInput.checked) {
        localStorage.setItem('p2p_session', JSON.stringify({
          email,
          password: btoa(password), // base64 pour masquer un peu
          annonces: data.annonces,
          achats: data.achats,
          recherches: data.recherches
        }));
      } else {
        localStorage.removeItem('p2p_session');
      }

      showMessage('success', 'Connexion réussie ✅');
      afficherInterface(data);

    } catch (err) {
      showMessage('error', err.message);
    }
    setLoading(false);
  }

  /** ======= ÉVÉNEMENTS ======= **/

  // Soumission formulaire : validation & appel login
  form.addEventListener('submit', e => {
    e.preventDefault();
    clearFieldErrors();

    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    let hasError = false;
    if (!emailRegex.test(email)) {
      setFieldError(emailInput, emailError, 'Email invalide');
      hasError = true;
    }
    if (!password || password.length < 4) {
      setFieldError(passwordInput, passwordError, 'Mot de passe trop court');
      hasError = true;
    }
    if (hasError) return;

    loginUser(email, password);
  });

  // Déconnexion : nettoyage localStorage + interface
  btnLogout.addEventListener('click', () => {
    localStorage.removeItem('p2p_session');
    document.getElementById('results').style.display = 'none';
    btnLogout.style.display = 'none';
    showMessage('info', 'Vous êtes déconnecté');
  });

  // Mot de passe oublié
  forgotLink.addEventListener('click', e => {
    e.preventDefault();
    const email = emailInput.value.trim();
    if (!email) {
      showMessage('error', 'Entrez votre email avant de demander un mot de passe');
      return;
    }
    fetch(API_FORGOT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    })
    .then(r => r.json())
    .then(() => showMessage('success', 'Email envoyé avec succès'))
    .catch(() => showMessage('error', 'Erreur envoi email'));
  });

  /** ======= AUTO LOGIN AU CHARGEMENT ======= **/
  window.addEventListener('DOMContentLoaded', () => {
    passwordInput.value = '';
    rememberInput.checked = true;
    btnLogout.style.display = 'none';

    const sessionRaw = localStorage.getItem('p2p_session');
    if (sessionRaw) {
      try {
        const session = JSON.parse(sessionRaw);
        emailInput.value = session.email || '';
        rememberInput.checked = true;
        // Recharge interface avec données sauvegardées
        afficherInterface({
          annonces: session.annonces || [],
          achats: session.achats || [],
          recherches: session.recherches || []
        });
      } catch {
        localStorage.removeItem('p2p_session');
      }
    }
  });
})();
</script>




</body>
</html>
